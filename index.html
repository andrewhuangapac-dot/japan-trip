<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京阪神亲子游 (v28: 地图全览版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background-color: #fff7ed; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        #app { height: 100%; display: flex; flex-direction: column; }
        .scroll-container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 100%; width: 100%; z-index: 1; }
        [v-cloak] { display: none; }
        .map-btn { transition: all 0.2s; }
        .map-btn:active { transform: scale(0.95); }
        .vip-badge { background: linear-gradient(135deg, #1f2937 0%, #000000 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; box-shadow: 0 2px 4px rgba(0,0,0, 0.2); }
        .hotel-badge { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .game-tag { background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 4px; }
        .food-card { background-color: #fffbeb; border: 1px solid #fed7aa; border-radius: 0.75rem; padding: 0.75rem; margin-top: 0.75rem; box-shadow: 0 2px 5px rgba(251, 146, 60, 0.05); }
        .shop-card { background-color: #fff1f2; border: 1px solid #fda4af; border-radius: 0.75rem; padding: 0.75rem; margin-top: 0.5rem; color: #9f1239; }
        .transport-detail { background-color: #f8fafc; border-left: 3px solid #64748b; padding: 0.75rem; margin-top: 0.5rem; border-radius: 0 0.5rem 0.5rem 0; }
        .jp-text { font-family: "Hiragino Sans", "Yu Gothic", sans-serif; }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white shadow-2xl relative">
    
    <header class="flex-none bg-gradient-to-r from-orange-600 to-red-600 text-white p-5 pb-4 rounded-b-[2rem] shadow-xl z-20">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-xl font-bold tracking-wide">京阪神亲子游 (全览版)</h1>
                <p class="text-orange-100 text-xs mt-1 font-medium">9&12岁少年团 | 大阪·神户·京都</p>
            </div>
            <button @click="resetData" class="text-xs bg-white/20 border border-white/30 px-3 py-1.5 rounded-full hover:bg-white/30 transition backdrop-blur-sm">重置</button>
        </div>
        <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
            <button v-for="(day, index) in days" :key="index" @click="changeDay(index)"
                :class="currentDay === index ? 'bg-white text-orange-700 font-bold shadow-lg scale-105 ring-2 ring-white/50' : 'bg-orange-800/40 text-orange-100 hover:bg-orange-700/60'"
                class="px-3 py-2 rounded-xl text-xs whitespace-nowrap transition-all flex-shrink-0 mb-2 flex flex-col items-center min-w-[4.5rem]">
                <span>{{ day.date }}</span>
                <span class="text-[10px] opacity-80 mt-0.5">{{ day.weather.temp_high }}°</span>
            </button>
        </div>
    </header>

    <main class="scroll-container bg-stone-50">
        
        <div v-show="currentView === 'list'" class="pb-24 px-4 pt-4">
            <div class="mb-5 bg-white rounded-2xl p-4 shadow-sm border border-stone-200 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-stone-800">{{ days[currentDay].name }}</h2>
                    <div class="flex items-center mt-1 text-sm font-medium" :class="days[currentDay].weather.color">
                        <i :class="days[currentDay].weather.icon" class="mr-2 text-lg"></i>
                        <span>{{ days[currentDay].weather.status }}</span>
                    </div>
                </div>
            </div>

            <div class="space-y-5">
                <div v-for="item in sortedActivities" :key="item.id" class="relative pl-6 border-l-[3px] border-stone-200 last:border-0">
                    <div class="absolute -left-[10px] top-5 w-5 h-5 rounded-full border-4 border-white shadow-sm transition-colors duration-300"
                         :class="getIconColor(item)"></div>
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 hover:shadow-md transition-all duration-300 group">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 mr-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-stone-100 text-stone-600 text-[11px] font-bold px-2 py-0.5 rounded" :class="{'text-red-600 bg-red-50': isKeyTime(item.time)}">{{ item.time }}</span>
                                    <span v-if="item.isHotel" class="hotel-badge"><i class="fas fa-bed mr-1"></i>饭店</span>
                                    <span v-if="item.recommend" class="vip-badge"><i class="fab fa-uber mr-1"></i>Uber</span>
                                    <span v-if="item.isGame" class="game-tag"><i class="fas fa-gamepad mr-1"></i>必去</span>
                                </div>
                                <h3 class="font-bold text-stone-800 text-[15px] leading-tight jp-text">{{ item.location }}</h3>
                                <p class="text-stone-600 text-sm mt-1 font-medium jp-text">{{ item.action }}</p>
                                
                                <div v-if="item.transport_detail" class="transport-detail">
                                    <p class="text-xs text-slate-800 font-bold mb-1"><i class="fas fa-info-circle mr-1 text-slate-500"></i>指引：</p>
                                    <p class="text-[11px] text-slate-600 leading-relaxed whitespace-pre-line jp-text">{{ item.transport_detail }}</p>
                                </div>
                                <div v-if="item.note && !item.transport_detail" class="mt-2 text-xs text-stone-500 bg-stone-50 p-2 rounded-lg">
                                    <i class="fas fa-info-circle mr-1 text-stone-400"></i>{{ item.note }}
                                </div>
                                <div v-if="item.foodOptions" class="food-card">
                                    <p class="text-xs font-bold text-orange-700 mb-2 border-b border-orange-100 pb-1"><i class="fas fa-utensils mr-1"></i>餐饮推荐</p>
                                    <div class="space-y-2">
                                        <div v-for="(food, fIdx) in item.foodOptions" :key="fIdx" class="flex items-center justify-between">
                                            <div>
                                                <p class="text-xs font-bold text-gray-800 jp-text">{{ food.name }}</p>
                                                <p class="text-[10px] text-gray-500">{{ food.desc }}</p>
                                            </div>
                                            <a :href="food.link" target="_blank" class="text-orange-500 hover:text-orange-700 ml-2 p-1 bg-orange-50 rounded-lg"><i class="fas fa-map-marker-alt"></i></a>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="item.shopping" class="shop-card flex items-center justify-between">
                                    <div>
                                        <p class="text-xs font-bold jp-text"><i class="fas fa-shopping-cart mr-1"></i>{{ item.shopping.name }}</p>
                                        <p class="text-[10px] opacity-80">{{ item.shopping.desc }}</p>
                                    </div>
                                    <a :href="item.shopping.link" target="_blank" class="bg-white text-pink-600 w-6 h-6 flex items-center justify-center rounded-full shadow-sm"><i class="fas fa-map-pin text-[10px]"></i></a>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-3 pt-1">
                                <button v-if="item.link" @click="openSmartMap(item)" class="map-btn w-10 h-10 rounded-xl bg-black text-white shadow-md hover:bg-gray-800 flex items-center justify-center"><i class="fas fa-location-arrow text-sm"></i></button>
                                <button v-else class="w-10 h-10 rounded-xl bg-stone-100 text-stone-300 flex items-center justify-center cursor-default"><i class="fas fa-map-marker-alt text-sm"></i></button>
                                <button @click="editActivity(item)" class="map-btn w-10 h-10 rounded-xl bg-stone-50 text-stone-400 flex items-center justify-center hover:bg-stone-100"><i class="fas fa-pen text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentView === 'map'" class="absolute inset-0 z-0 bg-gray-100 h-full w-full">
            <div id="map"></div>
            
            <div class="absolute top-4 left-4 z-[500] bg-white/90 backdrop-blur p-3 rounded-xl shadow-lg border border-stone-200">
                <p class="text-xs font-bold text-stone-700 mb-1">地图图例</p>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-purple-500"></span><span class="text-[10px]">饭店</span></div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span><span class="text-[10px]">景点/交通</span></div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-red-500"></span><span class="text-[10px]">动漫/游戏</span></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-500"></span><span class="text-[10px]">餐厅</span></div>
            </div>

            <div class="absolute bottom-24 left-4 z-[500]">
                <button @click="toggleMapMode" class="bg-white text-stone-800 px-4 py-2 rounded-full shadow-lg font-bold text-xs flex items-center border border-stone-200 hover:bg-stone-50 active:scale-95 transition-all">
                    <i class="fas mr-2" :class="showAllMap ? 'fa-map' : 'fa-map-pin'"></i>
                    {{ showAllMap ? '显示全览 (All)' : `仅看 Day ${currentDay + 1}` }}
                </button>
            </div>
        </div>
    </main>

    <nav class="flex-none bg-white/95 backdrop-blur border-t border-stone-100 px-6 py-2 flex justify-between items-center z-30 pb-6 pt-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button @click="currentView = 'list'" :class="currentView === 'list' ? 'text-orange-600' : 'text-stone-400'" class="flex flex-col items-center w-16 transition-colors">
            <i class="fas fa-list-ul text-lg mb-1"></i><span class="text-[10px] font-medium">行程</span>
        </button>
        <button @click="openModal()" class="bg-orange-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg shadow-orange-200 -translate-y-5 hover:scale-105 active:scale-95 transition-all">
            <i class="fas fa-plus text-xl"></i>
        </button>
        <button @click="switchMap" :class="currentView === 'map' ? 'text-orange-600' : 'text-stone-400'" class="flex flex-col items-center w-16 transition-colors">
            <i class="fas fa-map-marked-alt text-lg mb-1"></i><span class="text-[10px] font-medium">地图</span>
        </button>
    </nav>

    <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-stone-900/60 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-bounce-up">
            <h2 class="text-lg font-bold mb-4 text-stone-800">{{ isEditing ? '编辑行程' : '新增行程' }}</h2>
            <div class="space-y-3">
                <div class="flex gap-3">
                    <input type="time" v-model="form.time" class="w-1/3 bg-stone-50 border border-stone-200 rounded-xl p-3 outline-none focus:border-orange-500 transition">
                    <input type="text" v-model="form.location" placeholder="地点" class="w-2/3 bg-stone-50 border border-stone-200 rounded-xl p-3 outline-none focus:border-orange-500 transition">
                </div>
                <input type="text" v-model="form.action" placeholder="内容" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 outline-none focus:border-orange-500 transition">
                <input type="text" v-model="form.transport" placeholder="交通简述" class="w-full bg-stone-50 border border-stone-200 text-stone-800 rounded-xl p-3 outline-none focus:border-orange-400 placeholder-stone-400 transition">
                <textarea v-model="form.transport_detail" placeholder="说明" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 h-20 resize-none outline-none focus:border-orange-500 transition"></textarea>
                <input type="text" v-model="form.link" placeholder="Map Link" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-xs text-stone-500 outline-none focus:border-orange-500 transition">
            </div>
            <div class="flex gap-3 mt-6">
                <button v-if="isEditing" @click="deleteActivity" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold hover:bg-red-100 transition">删除</button>
                <button @click="showModal = false" class="flex-1 bg-stone-100 text-stone-500 py-3 rounded-xl font-medium hover:bg-stone-200 transition">取消</button>
                <button @click="saveActivity" class="flex-[2] bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 shadow-lg shadow-orange-200 transition">储存</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    // v28 Data: Same detailed data, optimized for map display
    const detailedData = {
        0: [
            { id: 1, time: '16:50', location: '关西机场 T2', action: '接驳巴士', transport: '免费巴士', link: 'https://www.google.com/maps/search/?api=1&query=Aeroplaza+Kansai+Airport', coords: [34.4357, 135.2443] },
            { id: 2, time: '17:35', location: '关西机场站', action: 'Rapi:t α 特急', transport: '17:35 发车', transport_detail: '深蓝色铁人28号列车。', link: 'https://www.google.com/maps/search/?api=1&query=Nankai+Kansai+Airport+Station', coords: [34.4367, 135.2435] },
            { id: 3, time: '18:15', location: '南海难波站', action: '出站步行', transport: '步行', link: 'https://www.google.com/maps/search/?api=1&query=Namba+Station+Nankai', coords: [34.6631, 135.5023] },
            { id: 4, time: '18:30', location: 'Caption by Hyatt', action: 'Check-in', transport: '步行', isHotel: true, link: 'https://www.google.com/maps/search/?api=1&query=Caption+by+Hyatt+Namba+Osaka', coords: [34.6655, 135.5065] },
            { id: 5, time: '19:15', location: '道顿堀', action: '晚餐 & 夹娃娃', transport: '步行', link: 'https://www.google.com/maps/search/?api=1&query=Dotonbori+Glico+Sign', coords: [34.6687, 135.5013], foodOptions: [{name:'一兰', desc:'拉面'}, {name:'力丸烧肉', desc:'吃到饱'}] }
        ],
        1: [
            { id: 7, time: '09:00', location: '日本桥 → 神户', action: '移动', transport: '阪神电车', coords: [34.6672, 135.5065] },
            { id: 11, time: '11:30', location: '三宫市区', action: '神户牛午餐', transport: '步行', link: 'https://www.google.com/maps/search/?api=1&query=Kobe+Sannomiya+Station', coords: [34.6930, 135.1915], foodOptions: [{name:'Steakland', desc:'CP值高'}] },
            { id: 12, time: '14:00', location: '三宫 → 神户港', action: '移动', transport: 'Uber', recommend: true, link: 'https://www.google.com/maps/search/?api=1&query=Kobe+Harborland+umie+Mosaic', coords: [34.6795, 135.1843] },
            { id: 13, time: '14:30', location: '神户港 (Mosaic)', action: '逛街/扭蛋', transport: '步行', isGame: true, link: 'https://www.google.com/maps/search/?api=1&query=Mosaic+Kobe', coords: [34.6795, 135.1843], shopping: {name:'扭蛋百货', desc:'3F 必去'} },
            { id: 14, time: '17:30', location: 'Mosaic → 大阪', action: '回程', transport: '阪神电车', coords: [34.6815, 135.1765] },
            { id: 15, time: '19:00', location: '日本桥', action: '晚餐', transport: '步行', coords: [34.6672, 135.5065], foodOptions: [{name:'天政乌龙面', desc:'快速便宜'}] }
        ],
        2: [
            { id: 16, time: '09:30', location: '黑门市场', action: '早午餐', transport: '步行', link: 'https://www.google.com/maps/search/?api=1&query=Kuromon+Ichiba+Market', coords: [34.6654, 135.5065] },
            { id: 17, time: '11:00', location: '淀屋桥站', action: '转乘京阪', transport: 'Uber', link: 'https://www.google.com/maps/search/?api=1&query=Yodoyabashi+Station', coords: [34.6930, 135.5015] },
            { id: 18, time: '11:30', location: '京阪特急', action: '移动至京都', transport: 'Premium Car', link: 'https://www.google.com/maps/search/?api=1&query=Jingu-Marutamachi+Station', coords: [35.0175, 135.7725] },
            { id: 19, time: '12:30', location: 'Hyatt Place Kyoto', action: 'Check-in', transport: 'Uber', isHotel: true, coords: [35.0163, 135.7592] },
            { id: 20, time: '13:30', location: '锦市场', action: '小吃午餐', transport: 'Uber', coords: [35.0050, 135.7630] },
            { id: 21, time: '15:30', location: 'Nintendo Kyoto', action: '朝圣采购', transport: '步行', isGame: true, link: 'https://www.google.com/maps/search/?api=1&query=Nintendo+Kyoto', coords: [35.0038, 135.7695], shopping: {name:'Nintendo Store', desc:'高岛屋T8'} },
            { id: 22, time: '18:00', location: '四条 / 乌丸', action: '晚餐', transport: '步行', coords: [35.0035, 135.7595] }
        ],
        3: [
            { id: 23, time: '08:30', location: '伏见稻荷', action: '千本鸟居', transport: 'Uber', recommend: true, link: 'https://www.google.com/maps/search/?api=1&query=Fushimi+Inari+Taisha', coords: [34.9671, 135.7726] },
            { id: 24, time: '10:30', location: '伏见稻荷 → 清水寺', action: '移动', transport: 'Uber', coords: [34.9949, 135.7850] },
            { id: 25, time: '12:00', location: '清水寺周边', action: '午餐', transport: '步行', coords: [34.9960, 135.7830], foodOptions: [{name:'清水顺正', desc:'汤豆腐'}] },
            { id: 26, time: '14:30', location: '三年坂 / 二年坂', action: '吉卜力/角落生物', transport: '步行', isGame: true, link: 'https://www.google.com/maps/search/?api=1&query=Donguri+Kyowakoku+Ninenzaka', coords: [35.0035, 135.7780], shopping: {name:'橡子共和国', desc:'吉卜力周边'} },
            { id: 27, time: '18:00', location: '河原町', action: '晚餐', transport: '步行', coords: [35.0040, 135.7730] }
        ],
        4: [
            { id: 29, time: '08:05', location: '京都站 (八条口)', action: '前往机场', transport: 'Uber', coords: [34.9850, 135.7580] },
            { id: 30, time: '08:45', location: 'Haruka 特急', action: '前往机场', transport: 'Hello Kitty列车', coords: [34.9850, 135.7580] },
            { id: 31, time: '10:05', location: '关西机场 T1', action: '最后采购', transport: '接驳车', coords: [34.4357, 135.2443], shopping: {name:'Pokemon Store', desc:'2F 商店'} }
        ]
    };

    const app = createApp({
        data() {
            return {
                currentDay: 0,
                currentView: 'list',
                showModal: false,
                isEditing: false,
                showAllMap: true, // v28: Default to showing ALL map points
                mapInstance: null,
                markerGroup: null,
                days: [
                    { date: '12/12 (五)', name: 'Day 1: 抵达大阪', weather: { status: '晴时多云', icon: 'fas fa-sun', temp_high: 11, color: 'text-orange-500' } },
                    { date: '12/13 (六)', name: 'Day 2: 神户/扭蛋', weather: { status: '多云时阴', icon: 'fas fa-cloud', temp_high: 11, color: 'text-gray-500' } },
                    { date: '12/14 (日)', name: 'Day 3: 京都/任天堂', weather: { status: '阴短暂雨', icon: 'fas fa-cloud-rain', temp_high: 14, color: 'text-blue-500' } },
                    { date: '12/15 (一)', name: 'Day 4: 清水寺/寻宝', weather: { status: '多云', icon: 'fas fa-cloud', temp_high: 11, color: 'text-gray-500' } },
                    { date: '12/16 (二)', name: 'Day 5: 返程', weather: { status: '晴朗', icon: 'fas fa-sun', temp_high: 12, color: 'text-orange-500' } }
                ],
                activities: {},
                form: { id: null, time: '', location: '', action: '', transport: '', note: '', transport_detail: '', link: '', isHotel: false, isGame: false, recommend: false }
            }
        },
        computed: {
            currentActivities() { return this.activities[this.currentDay] || []; },
            sortedActivities() { return [...this.currentActivities].sort((a, b) => a.time.localeCompare(b.time)); }
        },
        mounted() { this.loadAndMergeData(); },
        methods: {
            loadAndMergeData() {
                try {
                    const saved = localStorage.getItem('japanTrip_v28_MapFix');
                    if (saved) { this.activities = JSON.parse(saved); } 
                    else { this.activities = JSON.parse(JSON.stringify(detailedData)); this.saveToStorage(); }
                } catch(e) { this.activities = JSON.parse(JSON.stringify(detailedData)); }
            },
            changeDay(index) {
                this.currentDay = index;
                this.currentView = 'list';
                this.showAllMap = false; // When clicking a specific day in header, switch map mode to specific
                if (this.mapInstance) this.$nextTick(() => { this.updateMapMarkers(); });
            },
            switchMap() {
                this.currentView = 'map';
                this.showAllMap = true; // Default to Show All when clicking Map tab
                this.$nextTick(() => {
                    if (!this.mapInstance) this.initMap();
                    else { this.mapInstance.invalidateSize(); this.updateMapMarkers(); }
                });
            },
            toggleMapMode() {
                this.showAllMap = !this.showAllMap;
                this.updateMapMarkers();
            },
            initMap() {
                this.mapInstance = L.map('map');
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap', maxZoom: 19 }).addTo(this.mapInstance);
                this.markerGroup = L.layerGroup().addTo(this.mapInstance);
                this.updateMapMarkers();
            },
            updateMapMarkers() {
                if (!this.mapInstance || !this.markerGroup) return;
                this.markerGroup.clearLayers();
                
                let actsToShow = [];
                const bounds = [];

                if (this.showAllMap) {
                    // Flatten all days
                    Object.keys(this.activities).forEach(key => {
                        const dayIndex = parseInt(key);
                        const dayActs = this.activities[key];
                        dayActs.forEach(act => {
                            actsToShow.push({ ...act, dayLabel: `Day ${dayIndex + 1}` });
                        });
                    });
                } else {
                    // Show only current day
                    const dayActs = this.currentActivities;
                    dayActs.forEach(act => {
                        actsToShow.push({ ...act, dayLabel: `Day ${this.currentDay + 1}` });
                    });
                }

                actsToShow.forEach(item => {
                    if (item.coords) {
                        let color = 'blue';
                        if (item.isHotel) color = 'purple';
                        else if (item.foodOptions) color = 'orange';
                        else if (item.isGame) color = 'red';

                        const marker = L.circleMarker(item.coords, {
                            color: color === 'purple' ? '#8b5cf6' : (color === 'orange' ? '#f97316' : (color === 'red' ? '#ef4444' : '#3b82f6')),
                            fillColor: color === 'purple' ? '#8b5cf6' : (color === 'orange' ? '#f97316' : (color === 'red' ? '#ef4444' : '#3b82f6')),
                            fillOpacity: 0.8,
                            radius: 8
                        }).addTo(this.markerGroup);
                        
                        // Enhanced Popup
                        marker.bindPopup(`
                            <div style="font-family: sans-serif;">
                                <div style="font-size:10px; color:#666; font-weight:bold;">[${item.dayLabel}] ${item.time}</div>
                                <div style="font-size:14px; font-weight:bold; margin-bottom:2px;">${item.location}</div>
                                <div style="font-size:12px;">${item.action}</div>
                            </div>
                        `);
                        bounds.push(item.coords);
                    }
                });

                if (bounds.length > 0) {
                    this.mapInstance.fitBounds(bounds, { padding: [50, 50] });
                }
            },
            openSmartMap(item) { if (item.link) window.open(item.link, '_blank'); },
            getIconColor(item) {
                if (item.isHotel) return 'bg-purple-500';
                if (item.isGame) return 'bg-red-500 ring-2 ring-red-200';
                if (item.recommend) return 'bg-black border-black'; 
                if (item.transport) return 'bg-blue-600'; 
                return 'bg-stone-300';
            },
            isKeyTime(time) { return (time === '17:35' || time === '08:45'); },
            openModal(item = null) {
                this.isEditing = !!item;
                this.form = item ? { ...item } : { id: Date.now(), time: '09:00', location: '', action: '', transport: '', note: '', transport_detail: '', link: '', isHotel: false, isGame: false, recommend: false };
                this.showModal = true;
            },
            saveActivity() {
                if (!this.form.location) return alert('请输入地点');
                if (!this.activities[this.currentDay]) this.activities[this.currentDay] = [];
                if (this.isEditing) {
                    const idx = this.activities[this.currentDay].findIndex(x => x.id === this.form.id);
                    if (idx !== -1) this.activities[this.currentDay][idx] = { ...this.form };
                } else { this.activities[this.currentDay].push({ ...this.form }); }
                this.saveToStorage();
                this.showModal = false;
            },
            deleteActivity() {
                if(confirm('删除此行程？')) {
                    this.activities[this.currentDay] = this.activities[this.currentDay].filter(x => x.id !== this.form.id);
                    this.saveToStorage();
                    this.showModal = false;
                }
            },
            saveToStorage() { localStorage.setItem('japanTrip_v28_MapFix', JSON.stringify(this.activities)); },
            resetData() {
                if(confirm('重置数据？')) {
                    this.activities = JSON.parse(JSON.stringify(detailedData));
                    this.saveToStorage();
                    this.currentDay = 0;
                    alert('已更新！');
                }
            }
        }
    });
    app.mount('#app');
</script>
</body>
</html>
