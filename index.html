<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京阪神親子遊 (Rapi:t α版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 100%; width: 100%; z-index: 1; }
        [v-cloak] { display: none; }
        .tip-box { background-color: #eff6ff; border-left: 4px solid #3b82f6; padding: 8px; font-size: 12px; margin-top: 6px; color: #1e40af; }
        .warning-box { background-color: #fef2f2; border-left: 4px solid #ef4444; padding: 8px; font-size: 12px; margin-top: 6px; color: #991b1b; }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen relative shadow-2xl flex flex-col">
    
    <header class="bg-gradient-to-br from-indigo-700 to-blue-800 text-white p-5 pb-4 rounded-b-[2rem] shadow-xl z-20 sticky top-0">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-xl font-bold tracking-wide">京阪神親子遊 ✈️</h1>
                <p class="text-indigo-100 text-xs mt-1 font-medium">Day 1: 南海特急 Rapi:t α 直達</p>
            </div>
            <button @click="resetData" class="text-xs bg-white/20 border border-white/30 px-3 py-1.5 rounded-full hover:bg-white/30 transition backdrop-blur-sm">重置</button>
        </div>
        <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
            <button v-for="(day, index) in days" :key="index" @click="changeDay(index)"
                :class="currentDay === index ? 'bg-white text-blue-800 font-bold shadow-lg scale-105 ring-2 ring-white/50' : 'bg-indigo-800/40 text-indigo-100 hover:bg-indigo-700/60'"
                class="px-3 py-2 rounded-xl text-xs whitespace-nowrap transition-all flex-shrink-0 mb-2 flex flex-col items-center min-w-[4.5rem]">
                <span>{{ day.date }}</span>
                <span class="text-[10px] opacity-80 mt-0.5">{{ day.weather.temp_high }}°</span>
            </button>
        </div>
    </header>

    <main class="flex-1 relative bg-slate-50 overflow-hidden">
        
        <div v-show="currentView === 'list'" class="h-full overflow-y-auto pb-24 px-4 pt-4 no-scrollbar">
            
            <div class="mb-5 bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-slate-800">{{ days[currentDay].name }}</h2>
                    <div class="flex items-center mt-1 text-sm font-medium" :class="days[currentDay].weather.color">
                        <i :class="days[currentDay].weather.icon" class="mr-2 text-lg"></i>
                        <span>{{ days[currentDay].weather.status }}</span>
                    </div>
                </div>
                <div v-if="days[currentDay].weather.rain" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-lg">
                    <i class="fas fa-umbrella mr-1"></i>帶傘
                </div>
            </div>

            <div class="space-y-5 pb-20">
                <div v-for="item in sortedActivities" :key="item.id" class="relative pl-6 border-l-[3px] border-slate-200 last:border-0">
                    <div class="absolute -left-[10px] top-5 w-5 h-5 rounded-full border-4 border-white shadow-sm transition-colors duration-300"
                         :class="getIconColor(item)"></div>
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all duration-300 group">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 mr-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-slate-100 text-slate-600 text-[11px] font-bold px-2 py-0.5 rounded">{{ item.time }}</span>
                                    <span v-if="item.isHotel" class="text-[10px] text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded border border-purple-100 font-medium">
                                        <i class="fas fa-bed mr-1"></i>住宿
                                    </span>
                                </div>
                                <h3 class="font-bold text-slate-800 text-[15px] leading-tight">{{ item.location }}</h3>
                                <p class="text-slate-600 text-sm mt-1 font-medium">{{ item.action }}</p>
                                
                                <div v-if="item.transport" class="mt-2.5 p-2.5 bg-indigo-50/60 rounded-xl border border-indigo-100">
                                    <p class="text-xs text-indigo-800 font-semibold mb-1">
                                        <i class="fas fa-train mr-1.5 w-3"></i>{{ item.transport }}
                                    </p>
                                    <p v-if="item.note" class="text-[11px] text-slate-600 leading-relaxed pl-5 border-l-2 border-indigo-200 ml-1">
                                        {{ item.note }}
                                    </p>
                                </div>
                                <div v-else-if="item.note" class="mt-2 text-xs text-slate-500 bg-slate-50 p-2 rounded-lg">
                                    <i class="fas fa-info-circle mr-1 text-slate-400"></i>{{ item.note }}
                                </div>

                                <div v-if="item.tip" class="tip-box rounded-lg flex items-start">
                                    <i class="fas fa-lightbulb mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span class="leading-relaxed">{{ item.tip }}</span>
                                </div>
                                <div v-if="item.warning" class="warning-box rounded-lg flex items-start">
                                    <i class="fas fa-exclamation-triangle mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span class="leading-relaxed">{{ item.warning }}</span>
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-3 pt-1">
                                <button v-if="item.link" @click="openSmartMap(item)" 
                                    class="w-10 h-10 rounded-xl bg-emerald-500 text-white shadow-emerald-200 shadow-md hover:bg-emerald-600 flex items-center justify-center transition-all active:scale-90">
                                    <i class="fas fa-location-arrow text-sm"></i>
                                </button>
                                <button v-else class="w-10 h-10 rounded-xl bg-slate-100 text-slate-300 flex items-center justify-center cursor-default">
                                    <i class="fas fa-map-marker-alt text-sm"></i>
                                </button>
                                
                                <button @click="editActivity(item)" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 flex items-center justify-center hover:bg-slate-100 active:scale-90 transition-transform">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentView === 'map'" class="absolute inset-0 z-0">
            <div id="map"></div>
        </div>
    </main>

    <nav class="absolute bottom-0 w-full bg-white/95 backdrop-blur border-t border-slate-100 px-6 py-2 flex justify-between items-center z-30 pb-6 pt-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button @click="currentView = 'list'" :class="currentView === 'list' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center w-16 transition-colors">
            <i class="fas fa-list-ul text-lg mb-1"></i><span class="text-[10px] font-medium">行程</span>
        </button>
        <button @click="openModal()" class="bg-indigo-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg shadow-indigo-200 -translate-y-5 hover:bg-indigo-700 active:scale-95 transition-all">
            <i class="fas fa-plus text-xl"></i>
        </button>
        <button @click="switchMap" :class="currentView === 'map' ? 'text-indigo-600' : 'text-slate-400'" class="flex flex-col items-center w-16 transition-colors">
            <i class="fas fa-map-marked-alt text-lg mb-1"></i><span class="text-[10px] font-medium">地圖</span>
        </button>
    </nav>

    <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-slate-900/60 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-bounce-up">
            <h2 class="text-lg font-bold mb-4 text-slate-800">{{ isEditing ? '編輯行程' : '新增行程' }}</h2>
            <div class="space-y-3">
                <div class="flex gap-3">
                    <input type="time" v-model="form.time" class="w-1/3 bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-indigo-500 transition">
                    <input type="text" v-model="form.location" placeholder="地點" class="w-2/3 bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-indigo-500 transition">
                </div>
                <input type="text" v-model="form.action" placeholder="內容" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-indigo-500 transition">
                <input type="text" v-model="form.transport" placeholder="交通" class="w-full bg-indigo-50 border border-indigo-100 text-indigo-800 rounded-xl p-3 outline-none focus:border-indigo-400 placeholder-indigo-300 transition">
                <textarea v-model="form.note" placeholder="備註" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 h-20 resize-none outline-none focus:border-indigo-500 transition"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button v-if="isEditing" @click="deleteActivity" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold hover:bg-red-100 transition">刪除</button>
                <button @click="showModal = false" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-medium hover:bg-slate-200 transition">取消</button>
                <button @click="saveActivity" class="flex-[2] bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">儲存</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    const detailedData = {
        0: [
            { id: 1, time: '16:00', location: '關西機場 T2', action: '轉搭接駁巴士', transport: '免費巴士', note: '入境後，前往 Aeroplaza 搭乘接駁車至 T1/關西機場站。' },
            { id: 2, time: '16:30', location: '關西機場站', action: '南海特急 Rapi:t α', transport: 'Rapi:t α 6', note: '您選擇了停靠站最少的 α (Alpha) 列車。全車指定席，請依照票面座位入座。', link: 'https://www.howto-osaka.com/tc/access/' },
            { id: 3, time: '17:05', location: '南海難波站 (終點)', action: '抵達 & 出站指引', transport: '步行 (推薦)', note: '抵達在 3F。請搭長扶梯下到 1F 的「北改札口」或「東出入口」。', warning: '從難波站轉乘地鐵只有一站，但地下迷宮很複雜。建議直接走路面去飯店。', link: 'https://www.google.com/maps/dir/?api=1&origin=Namba+Station&destination=Nippombashi+Station&travelmode=walking' },
            { id: 4, time: '17:20', location: '前往日本橋/飯店', action: '地面步行', transport: '步行 (約10-12分)', isHotel: true, note: '從「難波 CITY」東側出來，往「Den Den Town (電器街)」方向走。這段路比地下迷宮簡單，且沿途有店家。', tip: '沿途經過難波公園 (Namba Parks) 邊緣，直走過堺筋大馬路即抵達黑門市場/日本橋區域。' },
            { id: 5, time: '19:00', location: '道頓堀 / 裏難波', action: '晚餐', transport: '步行', note: '放下行李後，可步行至道頓堀或「裏難波」區域覓食。' }
        ],
        1: [
            { id: 7, time: '09:00', location: '日本橋站', action: '前往神戶', transport: '阪神電車 (直達)', note: '進日本橋站，看標示往「尼崎/神戶三宮」方向。搭「快速急行」。', tip: '完全不用換車，一班車直達神戶三宮，約 45 分鐘。' },
            { id: 8, time: '10:00', location: '神戶三宮', action: '轉乘去纜車', transport: '地鐵 (一站)', note: '出站後，轉搭神戶地鐵(西神山手線)到「新神戶站」。', tip: '新神戶站出來就能看到布引香草園纜車站的指標。' },
            { id: 9, time: '10:30', location: '布引香草園', action: '空中纜車', transport: '纜車', note: '隨著纜車爬升，可以看見神戶港全景。山上可以散步、吃冰淇淋。' },
            { id: 10, time: '13:00', location: '三宮市區', action: '午餐', transport: '纜車下山', note: '搭纜車下山，回到三宮吃午餐。' },
            { id: 11, time: '15:00', location: '神戶港 (Mosaic)', action: '麵包超人/逛街', transport: 'JR神戶線', note: '三宮站搭JR到「神戶站」(3分鐘)。走路去海邊 Mosaic 廣場。' },
            { id: 12, time: '18:30', location: '高速神戶站', action: '回大阪', transport: '阪神電車 (直達)', note: '從 Mosaic 走去「高速神戶站」搭車，直達日本橋。' }
        ],
        2: [
            { id: 14, time: '09:30', location: '黑門市場', action: '早午餐', transport: '步行', note: '最後逛一下黑門市場。' },
            { id: 16, time: '11:00', location: '大阪 → 京都 (京阪電車)', action: '移動至京都 (免轉車)', transport: '地鐵(1站)+京阪電車', isHotel: true, note: '1. 日本橋搭地鐵到「北濱」(1站)\n2. 北濱轉「京阪電車特急」直達「神宮丸太町」\n3. 下車過橋走10分鐘到飯店', tip: '這條路線避開了繁忙的京都車站。京阪特急有雙層座位，孩子會很喜歡！' },
            { id: 18, time: '15:00', location: '京都御苑', action: '散步', transport: '步行', note: '飯店對面就是，環境清幽。' },
            { id: 19, time: '17:30', location: '錦市場 / 河原町', action: '晚餐', transport: '地鐵', note: '丸太町搭一站去烏丸御池，或搭兩站去四條。' }
        ],
        3: [
            { id: 21, time: '08:30', location: '飯店 → 伏見稻荷', action: '京阪電車攻略', transport: '京阪電車 (直達)', note: '走路去「神宮丸太町站」，搭京阪電車直達「伏見稻荷」。', tip: '完全不用去京都站人擠人！京阪電車這段路線是觀光神隊友。' },
            { id: 22, time: '10:30', location: '伏見稻荷 → 清水寺', action: '移動', transport: '京阪電車 + 走路/計程車', note: '搭京阪電車到「清水五條站」。出站後建議搭短程計程車(約800円)上山到清水道。', tip: '如果不搭計程車，從清水五條走上去約20分鐘(上坡)。帶孩子建議這小段搭車。' },
            { id: 23, time: '13:00', location: '清水寺', action: '參拜', transport: '步行', note: '參觀清水舞台。' },
            { id: 24, time: '14:30', location: '清水寺 → 祇園', action: '下坡散步', transport: '步行', note: '走三年坂、二年坂一路下坡。這方向走最輕鬆。' },
            { id: 25, time: '17:30', location: '祇園 → 飯店', action: '回程', transport: '京阪電車', note: '走到「祇園四條站」，搭京阪電車回「神宮丸太町」。' }
        ],
        4: [
            { id: 28, time: '08:00', location: '飯店 → 京都站', action: '前往車站', transport: '地鐵烏丸線', note: '飯店樓下就是丸太町站入口。搭到京都站。' },
            { id: 29, time: '08:30', location: '京都站 → 機場', action: 'Haruka 特急', transport: 'JR 特急', note: '30號月台。' },
            { id: 30, time: '10:00', location: '關西機場 T1 → T2', action: '轉搭接駁車', transport: '接駁巴士', note: '到 Aeroplaza 搭乘 T2 接駁車。' },
            { id: 31, time: '12:00', location: '回程', action: 'Safe Flight', transport: '飛機', note: '旅途愉快！' }
        ]
    };

    const app = createApp({
        data() {
            return {
                currentDay: 0,
                currentView: 'list',
                showModal: false,
                isEditing: false,
                mapInstance: null,
                days: [
                    { date: '12/12 (五)', name: 'Day 1: 抵達大阪', desc: 'Rapi:t α 直達難波', center: [34.6629, 135.5023], weather: { status: '晴時多雲', icon: 'fas fa-sun', temp_high: 11, temp_low: 5, color: 'text-orange-500', rain: false } },
                    { date: '12/13 (六)', name: 'Day 2: 神戶觀景', desc: '布引香草園纜車', center: [34.6946, 135.1954], weather: { status: '多雲時陰', icon: 'fas fa-cloud', temp_high: 11, temp_low: 4, color: 'text-gray-500', rain: false } },
                    { date: '12/14 (日)', name: 'Day 3: 移動京都', desc: '京阪電車免轉乘', center: [35.0163, 135.7592], weather: { status: '陰短暫雨', icon: 'fas fa-cloud-rain', temp_high: 14, temp_low: 7, color: 'text-blue-500', rain: true } },
                    { date: '12/15 (一)', name: 'Day 4: 清水寺', desc: '京阪電車攻略', center: [34.9949, 135.7850], weather: { status: '多雲', icon: 'fas fa-cloud', temp_high: 11, temp_low: 6, color: 'text-gray-500', rain: false } },
                    { date: '12/16 (二)', name: 'Day 5: 返程', desc: '地鐵直達京都站', center: [34.4320, 135.2304], weather: { status: '晴朗', icon: 'fas fa-sun', temp_high: 12, temp_low: 4, color: 'text-orange-500', rain: false } }
                ],
                activities: {},
                form: { id: null, time: '', location: '', action: '', transport: '', note: '', link: '', isHotel: false, tip: '', warning: '' }
            }
        },
        computed: {
            currentActivities() {
                return this.activities[this.currentDay] || [];
            },
            sortedActivities() {
                return [...this.currentActivities].sort((a, b) => a.time.localeCompare(b.time));
            }
        },
        mounted() {
            this.loadAndMergeData();
        },
        methods: {
            loadAndMergeData() {
                // 使用新的 key 來儲存，避免與舊版衝突
                try {
                    const saved = localStorage.getItem('japanTrip_v12_RapitAlpha');
                    if (saved) {
                        this.activities = JSON.parse(saved);
                    } else {
                        this.activities = JSON.parse(JSON.stringify(detailedData));
                        this.saveToStorage();
                    }
                } catch(e) {
                    this.activities = JSON.parse(JSON.stringify(detailedData));
                }
            },
            changeDay(index) {
                this.currentDay = index;
                this.currentView = 'list';
            },
            switchMap() {
                this.currentView = 'map';
                this.$nextTick(() => {
                    if (!this.mapInstance) this.initMap();
                    setTimeout(() => {
                        this.mapInstance.invalidateSize();
                        this.mapInstance.setView(this.days[this.currentDay].center, 14);
                    }, 100);
                });
            },
            initMap() {
                this.mapInstance = L.map('map').setView(this.days[this.currentDay].center, 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'OpenStreetMap', maxZoom: 19
                }).addTo(this.mapInstance);
            },
            openSmartMap(item) {
                if (item.link) window.open(item.link, '_blank');
            },
            getIconColor(item) {
                if (item.isHotel) return 'bg-purple-500';
                if (item.transport) return 'bg-indigo-500';
                return 'bg-slate-300';
            },
            openModal(item = null) {
                this.isEditing = !!item;
                this.form = item ? { ...item } : { id: Date.now(), time: '09:00', location: '', action: '', transport: '', note: '', link: '', isHotel: false, tip: '', warning: '' };
                this.showModal = true;
            },
            saveActivity() {
                if (!this.form.location) return alert('請輸入地點');
                if (!this.activities[this.currentDay]) this.activities[this.currentDay] = [];
                
                if (this.isEditing) {
                    const idx = this.activities[this.currentDay].findIndex(x => x.id === this.form.id);
                    if (idx !== -1) this.activities[this.currentDay][idx] = { ...this.form };
                } else {
                    this.activities[this.currentDay].push({ ...this.form });
                }
                this.saveToStorage();
                this.showModal = false;
            },
            deleteActivity() {
                if(confirm('刪除此行程？')) {
                    this.activities[this.currentDay] = this.activities[this.currentDay].filter(x => x.id !== this.form.id);
                    this.saveToStorage();
                    this.showModal = false;
                }
            },
            saveToStorage() {
                localStorage.setItem('japanTrip_v12_RapitAlpha', JSON.stringify(this.activities));
            },
            resetData() {
                if(confirm('重置將會清除自訂行程，恢復預設值。確定嗎？')) {
                    this.activities = JSON.parse(JSON.stringify(detailedData));
                    this.saveToStorage();
                    this.currentDay = 0;
                    alert('行程已更新為 Rapi:t α 版！');
                }
            }
        }
    });
    
    app.mount('#app');
</script>

<style>
@keyframes bounce-up { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
.animate-bounce-up { animation: bounce-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
</style>

</body>
</html>
