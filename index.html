<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京阪神亲子游 (v32: 稳定版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* 基础样式与重置 */
        body, html { height: 100%; margin: 0; overflow: hidden; background-color: #fff7ed; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        #app { height: 100%; display: flex; flex-direction: column; }
        .scroll-container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 100%; width: 100%; z-index: 1; }
        [v-cloak] { display: none; }
        
        /* UI 组件样式 */
        .map-btn { transition: all 0.2s; }
        .map-btn:active { transform: scale(0.95); }
        .vip-badge { background: linear-gradient(135deg, #1f2937 0%, #000000 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .hotel-badge { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .game-tag { background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 4px; }
        
        .food-card { background-color: #fffbeb; border: 1px solid #fed7aa; border-radius: 0.75rem; padding: 0.75rem; margin-top: 0.75rem; }
        .shop-card { background-color: #fff1f2; border: 1px solid #fda4af; border-radius: 0.75rem; padding: 0.75rem; margin-top: 0.5rem; color: #9f1239; cursor: pointer;}
        
        .jp-text { font-family: "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif; }
        .location-title { font-size: 15px; line-height: 1.4; font-weight: 700; color: #292524; }
        .location-sub { font-size: 11px; color: #57534e; font-weight: 400; display: block; margin-top: 2px; opacity: 0.8; }
        
        /* 列表项交互反馈 */
        .food-item { transition: background-color 0.2s; border-radius: 8px; padding: 8px; margin-bottom: 4px; border: 1px solid #fff; }
        .food-item:active { background-color: #ffedd5; border-color: #fdba74; }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white shadow-2xl relative">
    
    <header class="flex-none bg-gradient-to-r from-orange-600 to-red-600 text-white p-5 pb-4 rounded-b-[2rem] shadow-xl z-20">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-xl font-bold tracking-wide">京阪神亲子游 v32</h1>
                <p class="text-orange-100 text-xs mt-1 font-medium">全程地图指引 | 3语餐厅推荐</p>
            </div>
            <button @click="resetData" class="text-xs bg-white/20 border border-white/30 px-3 py-1.5 rounded-full hover:bg-white/30 transition backdrop-blur-sm">重置</button>
        </div>
        <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
            <button v-for="(day, index) in days" :key="index" @click="changeDay(index)"
                :class="currentDay === index ? 'bg-white text-orange-700 font-bold shadow-lg scale-105 ring-2 ring-white/50' : 'bg-orange-800/40 text-orange-100 hover:bg-orange-700/60'"
                class="px-3 py-2 rounded-xl text-xs whitespace-nowrap transition-all flex-shrink-0 mb-2 flex flex-col items-center min-w-[4.5rem]">
                <span>{{ day.date }}</span>
                <span class="text-[10px] opacity-80 mt-0.5">{{ day.weather.temp_high }}°</span>
            </button>
        </div>
    </header>

    <main class="scroll-container bg-stone-50">
        
        <div v-show="currentView === 'list'" class="pb-24 px-4 pt-4">
            <div class="mb-5 bg-white rounded-2xl p-4 shadow-sm border border-stone-200 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-stone-800">{{ days[currentDay].name }}</h2>
                    <div class="flex items-center mt-1 text-sm font-medium" :class="days[currentDay].weather.color">
                        <i :class="days[currentDay].weather.icon" class="mr-2 text-lg"></i>
                        <span>{{ days[currentDay].weather.status }}</span>
                    </div>
                </div>
            </div>

            <div class="space-y-5">
                <div v-for="item in sortedActivities" :key="item.id" class="relative pl-6 border-l-[3px] border-stone-200 last:border-0">
                    <div class="absolute -left-[10px] top-5 w-5 h-5 rounded-full border-4 border-white shadow-sm transition-colors duration-300"
                         :class="getIconColor(item)"></div>
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 hover:shadow-md transition-all duration-300 group">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 mr-3">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-stone-100 text-stone-600 text-[11px] font-bold px-2 py-0.5 rounded" :class="{'text-red-600 bg-red-50': isKeyTime(item.time)}">{{ item.time }}</span>
                                    <span v-if="item.isHotel" class="hotel-badge"><i class="fas fa-bed mr-1"></i>饭店</span>
                                    <span v-if="item.recommend" class="vip-badge"><i class="fab fa-uber mr-1"></i>Uber</span>
                                    <span v-if="item.isGame" class="game-tag"><i class="fas fa-gamepad mr-1"></i>必去</span>
                                </div>
                                
                                <div class="mb-1">
                                    <h3 class="location-title jp-text">{{ getMainName(item.location) }}</h3>
                                    <span class="location-sub jp-text">{{ getSubName(item.location) }}</span>
                                </div>

                                <p class="text-stone-600 text-sm mt-1 font-medium jp-text">{{ item.action }}</p>
                                
                                <div v-if="item.transport_detail" class="bg-slate-50 border-l-4 border-slate-400 p-3 mt-2 rounded-r-lg">
                                    <p class="text-xs text-slate-800 font-bold mb-1"><i class="fas fa-info-circle mr-1 text-slate-500"></i>指引：</p>
                                    <p class="text-[11px] text-slate-600 leading-relaxed whitespace-pre-line jp-text">{{ item.transport_detail }}</p>
                                </div>

                                <div v-if="item.foodOptions" class="food-card">
                                    <p class="text-xs font-bold text-orange-700 mb-2 border-b border-orange-100 pb-1 flex justify-between">
                                        <span><i class="fas fa-utensils mr-1"></i>精选餐厅 (3选1)</span>
                                    </p>
                                    <div class="space-y-1">
                                        <div v-for="(food, fIdx) in item.foodOptions" :key="fIdx" @click="navigateTo(food)" class="food-item flex items-center justify-between group/food cursor-pointer hover:bg-orange-50 bg-white shadow-sm">
                                            <div class="flex-1">
                                                <p class="text-xs font-bold text-gray-800 jp-text group-hover/food:text-orange-700">{{ getMainName(food.name) }}</p>
                                                <p class="text-[10px] text-gray-400 jp-text">{{ getSubName(food.name) }}</p>
                                                <p class="text-[10px] text-orange-600/70 mt-0.5">{{ food.desc }}</p>
                                            </div>
                                            <div class="text-stone-300 group-hover/food:text-orange-500 ml-2 bg-stone-50 p-2 rounded-full">
                                                <i class="fas fa-location-arrow text-xs"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="item.shopping" class="shop-card flex items-center justify-between" @click="navigateTo(item.shopping)">
                                    <div>
                                        <p class="text-xs font-bold jp-text"><i class="fas fa-shopping-cart mr-1"></i>{{ item.shopping.name }}</p>
                                        <p class="text-[10px] opacity-80">{{ item.shopping.desc }}</p>
                                    </div>
                                    <div class="bg-white text-pink-600 w-6 h-6 flex items-center justify-center rounded-full shadow-sm"><i class="fas fa-location-arrow text-[10px]"></i></div>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-3 pt-1">
                                <button @click="navigateTo(item)" class="map-btn w-12 h-12 rounded-xl bg-stone-800 text-white shadow-lg hover:bg-black flex flex-col items-center justify-center">
                                    <i class="fas fa-location-arrow text-sm mb-0.5"></i>
                                    <span class="text-[9px]">导航</span>
                                </button>
                                <button @click="editActivity(item)" class="map-btn w-12 h-10 rounded-xl bg-stone-100 text-stone-400 flex items-center justify-center hover:bg-stone-200"><i class="fas fa-pen text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentView === 'map'" class="absolute inset-0 z-0 bg-gray-100 h-full w-full">
            <div id="map"></div>
            
            <div class="absolute top-4 left-4 z-[500] bg-white/95 backdrop-blur p-3 rounded-xl shadow-lg border border-stone-200">
                <p class="text-xs font-bold text-stone-700 mb-2">图例说明</p>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-blue-500 shadow-sm border border-white"></span><span class="text-[10px]">主要景点/交通</span></div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-orange-500 shadow-sm border border-white"></span><span class="text-[10px]">推荐餐厅</span></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500 shadow-sm border border-white"></span><span class="text-[10px]">必去商店</span></div>
            </div>

            <div class="absolute bottom-24 left-4 z-[500]">
                <button @click="toggleMapMode" class="bg-white text-stone-800 px-4 py-3 rounded-full shadow-xl font-bold text-xs flex items-center border border-stone-200 hover:bg-stone-50 active:scale-95 transition-all">
                    <i class="fas mr-2 text-base" :class="showAllMap ? 'fa-map' : 'fa-map-pin'"></i>
                    {{ showAllMap ? '显示全览 (All Days)' : `仅看 Day ${currentDay + 1}` }}
                </button>
            </div>
        </div>
    </main>

    <nav class="flex-none bg-white/95 backdrop-blur border-t border-stone-100 px-6 py-2 flex justify-between items-center z-30 pb-6 pt-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button @click="currentView = 'list'" :class="currentView === 'list' ? 'text-orange-600' : 'text-stone-400'" class="flex flex-col items-center w-16 transition-colors">
            <i class="fas fa-list-ul text-lg mb-1"></i><span class="text-[10px] font-medium">行程列表</span>
        </button>
        <button @click="openModal()" class="bg-orange-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg shadow-orange-200 -translate-y-5 hover:scale-105 active:scale-95 transition-all">
            <i class="fas fa-plus text-xl"></i>
        </button>
        <button @click="switchMap" :class="currentView === 'map' ? 'text-orange-600' : 'text-stone-400'" class="flex flex-col items-center w-16 transition-colors">
            <i class="fas fa-map-marked-alt text-lg mb-1"></i><span class="text-[10px] font-medium">完整地图</span>
        </button>
    </nav>

    <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-stone-900/60 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-bounce-up">
            <h2 class="text-lg font-bold mb-4 text-stone-800">{{ isEditing ? '编辑行程' : '新增行程' }}</h2>
            <div class="space-y-3">
                <input type="time" v-model="form.time" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3">
                <input type="text" v-model="form.location" placeholder="地点 (中文 [日文])" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3">
                <input type="text" v-model="form.action" placeholder="活动内容" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3">
            </div>
            <div class="flex gap-3 mt-6">
                <button v-if="isEditing" @click="deleteActivity" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold">删除</button>
                <button @click="showModal = false" class="flex-1 bg-stone-100 text-stone-500 py-3 rounded-xl">取消</button>
                <button @click="saveActivity" class="flex-[2] bg-orange-600 text-white py-3 rounded-xl font-bold">储存</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    // v32 数据集：完整座标，完整午晚餐 (3家)，完整地图点
    const masterData = {
        0: [
            { id: 101, time: '16:50', location: '关西机场 T2 (関西空港 T2 / KIX T2)', action: '接驳巴士', transport_detail: '搭乘免费接驳巴士前往 T1/关西机场站。', coords: [34.4357, 135.2443] },
            { id: 102, time: '17:35', location: '关西机场站 (関西空港駅 / Kansai Airport St.)', action: 'Rapi:t α 特急', transport_detail: '搭乘南海电铁 17:35 发车的特急 Rapi:t α (深蓝色铁人28号)。', coords: [34.4367, 135.2435] },
            { id: 103, time: '18:15', location: '南海难波站 (南海難波駅 / Nankai Namba)', action: '抵达/出站', coords: [34.6631, 135.5023] },
            { id: 104, time: '18:30', location: 'Caption by Hyatt (大阪難波 / Namba)', action: '饭店 Check-in', isHotel: true, coords: [34.6655, 135.5065] },
            { id: 105, time: '19:15', location: '道顿堀 (道頓堀 / Dotonbori)', action: '晚餐 & 逛街', coords: [34.6687, 135.5013], 
              foodOptions: [
                  {name:'一兰拉面 (一蘭 / Ichiran)', desc:'道顿堀店，独立隔间有趣', coords: [34.6698, 135.5025]}, 
                  {name:'千房大阪烧 (千房 / Chibo)', desc:'道顿堀大楼店，有制作表演', coords: [34.6685, 135.5032]}, 
                  {name:'藏寿司 (くら寿司 / Kura Sushi)', desc:'道顿堀店，每5盘抽扭蛋', coords: [34.6680, 135.5010]}
              ] 
            }
        ],
        1: [
            { id: 201, time: '09:00', location: '近铁日本桥站 (近鉄日本橋駅 / Nippombashi St.)', action: '搭乘阪神电车前往神户', coords: [34.6672, 135.5065] },
            { id: 202, time: '11:30', location: '神户三宫 (神戸三宮 / Kobe Sannomiya)', action: '神户牛午餐', coords: [34.6930, 135.1915], 
              foodOptions: [
                  {name:'Steakland (ステーキランド)', desc:'高CP值神户牛铁板烧', coords: [34.6929, 135.1917]},
                  {name:'Red Rock (レッドロック)', desc:'网红烤牛肉丼饭，肉山视觉感', coords: [34.6925, 135.1905]},
                  {name:'石田屋 (石田屋 / Ishida)', desc:'三宫店，环境较高级的铁板烧', coords: [34.6938, 135.1920]}
              ] 
            },
            { id: 203, time: '14:00', location: '神户临海乐园 (神戸ハーバーランド / Kobe Harborland)', action: 'Umie Mosaic 广场', recommend: true, coords: [34.6795, 135.1843] },
            { id: 204, time: '14:30', location: 'Mosaic 广场 (モザイク / Mosaic)', action: '扭蛋百货 & 逛街', isGame: true, coords: [34.6795, 135.1843], shopping: {name:'扭蛋百货 (ガチャガチャ)', desc:'Mosaic 3F 专门店', coords: [34.6795, 135.1843]} },
            { id: 205, time: '17:30', location: '神户港塔 (神戸ポートタワー / Kobe Port Tower)', action: '欣赏夜景', coords: [34.6815, 135.1765] },
            { id: 206, time: '19:00', location: '日本桥 (日本橋 / Nippombashi)', action: '返回大阪晚餐', coords: [34.6672, 135.5065],
              foodOptions: [
                  {name:'天政乌龙面 (天政 / Tenmasa)', desc:'便宜好吃的站着吃乌龙面', coords: [34.6660, 135.5045]},
                  {name:'鸟贵族 (鳥貴族 / Torikizoku)', desc:'难波店，均一价日式串烧', coords: [34.6675, 135.5055]},
                  {name:'天下一品 (天下一品)', desc:'难波温莎店，招牌浓郁鸡白汤', coords: [34.6658, 135.5070]}
              ]
            }
        ],
        2: [
            { id: 301, time: '09:30', location: '黑门市场 (黒門市場 / Kuromon Market)', action: '海鲜串烧早午餐', coords: [34.6654, 135.5065] },
            { id: 302, time: '11:00', location: '淀屋桥站 (淀屋橋駅 / Yodoyabashi St.)', action: '搭乘京阪电车前往京都', coords: [34.6930, 135.5015] },
            { id: 303, time: '12:30', location: 'Hyatt Place Kyoto (京都 / Karasuma)', action: '饭店 Check-in', isHotel: true, coords: [35.0163, 135.7592] },
            { id: 304, time: '13:30', location: '锦市场 (錦市場 / Nishiki Market)', action: '午餐 & 逛街', coords: [35.0050, 135.7630],
              foodOptions: [
                  {name:'五行拉面 (五行 / Gogyo)', desc:'独特的焦香味噌拉面', coords: [35.0045, 135.7620]},
                  {name:'名代猪排 (かつくら / Katsukura)', desc:'三条本店，自己磨芝麻', coords: [35.0088, 135.7665]},
                  {name:'一风堂 (一風堂 / Ippudo)', desc:'锦市场旁，位置宽敞舒适', coords: [35.0042, 135.7625]}
              ]
            },
            { id: 305, time: '15:30', location: 'Nintendo Kyoto (任天堂京都店)', action: '高岛屋 T8 朝圣', isGame: true, coords: [35.0038, 135.7695], shopping: {name:'Nintendo Store', desc:'高岛屋 S.C. T8 7F', coords: [35.0038, 135.7695]} },
            { id: 306, time: '18:00', location: '四条乌丸 (四条烏丸 / Shijo Karasuma)', action: '周边晚餐', coords: [35.0035, 135.7595],
              foodOptions: [
                  {name:'猪一拉面 (麺屋 猪一 / Inoichi)', desc:'必比登推荐，清淡酱油系', coords: [35.0015, 135.7675]},
                  {name:'饺子ChaoChao (餃子チャオチャオ)', desc:'四条河原町店，一口饺子', coords: [35.0030, 135.7700]},
                  {name:'CoCo壹番屋 (CoCo壱番屋)', desc:'四条乌丸店，孩子最爱咖哩', coords: [35.0032, 135.7590]}
              ]
            }
        ],
        3: [
            { id: 401, time: '08:30', location: '伏见稻荷大社 (伏見稲荷大社 / Fushimi Inari)', action: '千本鸟居拍照', recommend: true, coords: [34.9671, 135.7726] },
            { id: 402, time: '10:30', location: '清水寺 (清水寺 / Kiyomizu-dera)', action: '清水舞台', coords: [34.9949, 135.7850] },
            { id: 403, time: '12:00', location: '清水道 (清水道 / Kiyomizu-michi)', action: '午餐休息', coords: [34.9960, 135.7830], 
              foodOptions: [
                  {name:'清水顺正 (順正 / Junsei)', desc:'著名的汤豆腐料理/怀石', coords: [34.9965, 135.7835]},
                  {name:'乌龙面 Omen (おめん / Omen)', desc:'高台寺店，蔬菜沾面', coords: [35.0005, 135.7805]}, 
                  {name:'日出乌龙面 (日之出 / Hinode)', desc:'永观堂附近，最强咖哩乌龙', coords: [35.0135, 135.7930]}
              ] 
            },
            { id: 404, time: '14:30', location: '三年坂 (産寧坂 / Sannenzaka)', action: '吉卜力/角落生物', isGame: true, coords: [35.0035, 135.7780], shopping: {name:'橡子共和国 (どんぐり共和国)', desc:'二年坂店，吉卜力周边', coords: [34.9985, 135.7800]} },
            { id: 405, time: '18:00', location: '河原町 (河原町 / Kawaramachi)', action: '鸭川散步 & 晚餐', coords: [35.0040, 135.7730],
              foodOptions: [
                  {name:'弘烧肉 (京の焼肉処 弘 / Hiro)', desc:'千本三条本店，需预约', coords: [35.0065, 135.7710]},
                  {name:'武藏寿司 (寿しのむさし / Musashi)', desc:'三条本店，老牌回转寿司', coords: [35.0090, 135.7695]},
                  {name:'尾张屋 (本家尾張屋 / Owariya)', desc:'本店，550年历史荞麦面', coords: [35.0115, 135.7610]}
              ]
            }
        ],
        4: [
            { id: 501, time: '08:05', location: '京都站 八条口 (京都駅 八条口 / Kyoto St.)', action: '搭乘 Uber 前往车站', coords: [34.9850, 135.7580] },
            { id: 502, time: '08:45', location: '特急 Haruka (特急はるか / Haruka)', action: '搭乘 Hello Kitty 列车前往机场', coords: [34.9850, 135.7580] },
            { id: 503, time: '10:05', location: '关西机场 T1 (関西空港 T1 / KIX T1)', action: '报到 & 最后午餐', coords: [34.4357, 135.2443], 
              shopping: {name:'Pokemon Store', desc:'T1 2F 关西机场店', coords: [34.4357, 135.2443]},
              foodOptions: [
                  {name:'神座拉面 (神座 / Kamukura)', desc:'T1 3F，著名的白菜拉面', coords: [34.4350, 135.2440]},
                  {name:'Sukiya (すき家 / Sukiya)', desc:'T1 2F，快速方便牛丼', coords: [34.4355, 135.2445]},
                  {name:'551蓬莱 (551 Horai)', desc:'T1 2F，必吃肉包/烧卖', coords: [34.4360, 135.2450]}
              ]
            }
        ]
    };

    const app = createApp({
        data() {
            return {
                currentDay: 0,
                currentView: 'list',
                showModal: false,
                isEditing: false,
                showAllMap: true, 
                mapInstance: null,
                markerGroup: null,
                days: [
                    { date: '12/12 (五)', name: 'Day 1: 抵达大阪', weather: { status: '晴时多云', icon: 'fas fa-sun', temp_high: 11, color: 'text-orange-500' } },
                    { date: '12/13 (六)', name: 'Day 2: 神户/扭蛋', weather: { status: '多云时阴', icon: 'fas fa-cloud', temp_high: 11, color: 'text-gray-500' } },
                    { date: '12/14 (日)', name: 'Day 3: 京都/任天堂', weather: { status: '阴短暂雨', icon: 'fas fa-cloud-rain', temp_high: 14, color: 'text-blue-500' } },
                    { date: '12/15 (一)', name: 'Day 4: 清水寺/寻宝', weather: { status: '多云', icon: 'fas fa-cloud', temp_high: 11, color: 'text-gray-500' } },
                    { date: '12/16 (二)', name: 'Day 5: 返程', weather: { status: '晴朗', icon: 'fas fa-sun', temp_high: 12, color: 'text-orange-500' } }
                ],
                activities: {},
                form: { id: null, time: '', location: '', action: '', transport_detail: '', coords: [] }
            }
        },
        computed: {
            currentActivities() { return this.activities[this.currentDay] || []; },
            sortedActivities() { return [...this.currentActivities].sort((a, b) => a.time.localeCompare(b.time)); }
        },
        mounted() { this.loadAndMergeData(); },
        methods: {
            // 工具函数：提取中/日名称
            getMainName(str) { return str ? str.split('(')[0] : ''; },
            getSubName(str) { 
                if(!str) return '';
                const match = str.match(/\(([^)]+)\)/);
                return match ? match[1] : '';
            },
            
            // 核心修复：数据加载与版本控制
            loadAndMergeData() {
                // 使用 v32_Stable 作为 Key，强制刷新数据
                try {
                    const saved = localStorage.getItem('japanTrip_v32_Stable');
                    if (saved) { 
                        this.activities = JSON.parse(saved); 
                    } else { 
                        this.activities = JSON.parse(JSON.stringify(masterData)); 
                        this.saveToStorage(); 
                    }
                } catch(e) { 
                    this.activities = JSON.parse(JSON.stringify(masterData)); 
                }
            },

            // 核心修复：智能导航系统 (100% 可用)
            navigateTo(item) {
                if (!item) return;

                let url = '';
                // 优先级 1: 经纬度 (最准确)
                if (item.coords && Array.isArray(item.coords) && item.coords.length === 2) {
                    url = `https://www.google.com/maps/search/?api=1&query=${item.coords[0]},${item.coords[1]}`;
                } 
                // 优先级 2: 名称搜索 (兜底)
                else {
                    const query = encodeURIComponent(this.getMainName(item.location || item.name) + ' ' + this.getSubName(item.location || item.name));
                    url = `https://www.google.com/maps/search/?api=1&query=${query}`;
                }
                
                // 使用 window.open 打开
                window.open(url, '_blank', 'noopener,noreferrer');
            },

            // 地图逻辑
            changeDay(index) {
                this.currentDay = index;
                this.currentView = 'list';
                this.showAllMap = false; 
                if (this.mapInstance) this.$nextTick(() => { this.updateMapMarkers(); });
            },
            switchMap() {
                this.currentView = 'map';
                this.showAllMap = true; 
                this.$nextTick(() => {
                    if (!this.mapInstance) this.initMap();
                    else { this.mapInstance.invalidateSize(); this.updateMapMarkers(); }
                });
            },
            toggleMapMode() {
                this.showAllMap = !this.showAllMap;
                this.updateMapMarkers();
            },
            initMap() {
                this.mapInstance = L.map('map');
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap', maxZoom: 19 }).addTo(this.mapInstance);
                this.markerGroup = L.layerGroup().addTo(this.mapInstance);
                this.updateMapMarkers();
            },
            updateMapMarkers() {
                if (!this.mapInstance || !this.markerGroup) return;
                this.markerGroup.clearLayers();
                
                let actsToShow = [];
                const bounds = [];

                // 辅助函数：提取一天内所有类型的点
                const getItemsForDay = (dayIndex) => {
                    const items = [];
                    if (this.activities[dayIndex]) {
                        this.activities[dayIndex].forEach(act => {
                            // 1. 主要行程点
                            if(act.coords) items.push({ ...act, dayLabel: `Day ${parseInt(dayIndex) + 1}`, type: 'main' });
                            
                            // 2. 餐厅点
                            if (act.foodOptions && act.foodOptions.length > 0) {
                                act.foodOptions.forEach(food => {
                                    if(food.coords) items.push({ id: 'food', coords: food.coords, location: food.name, action: food.desc, type: 'food' });
                                });
                            }
                            
                            // 3. 商店点
                            if (act.shopping && act.shopping.coords) {
                                items.push({ id: 'shop', coords: act.shopping.coords, location: act.shopping.name, action: act.shopping.desc, type: 'shop' });
                            }
                        });
                    }
                    return items;
                };

                // 决定显示范围
                if (this.showAllMap) {
                    Object.keys(this.activities).forEach(key => { actsToShow = actsToShow.concat(getItemsForDay(key)); });
                } else {
                    actsToShow = getItemsForDay(this.currentDay);
                }

                // 绘制 Marker
                actsToShow.forEach(item => {
                    if (item.coords) {
                        let color, radius, opacity;
                        
                        if (item.type === 'food') { color = '#f97316'; radius = 6; opacity = 0.9; } // 橘色：餐厅
                        else if (item.type === 'shop') { color = '#ef4444'; radius = 6; opacity = 0.9; } // 红色：商店
                        else { 
                            if (item.isHotel) color = '#8b5cf6'; // 紫色：饭店
                            else color = '#3b82f6'; // 蓝色：一般
                            radius = 8; opacity = 0.8;
                        }

                        const marker = L.circleMarker(item.coords, {
                            color: color, fillColor: color, fillOpacity: opacity, radius: radius, weight: 2, stroke: true
                        }).addTo(this.markerGroup);
                        
                        // 构建 Popup HTML（不再依赖复杂 JS，直接嵌入链接）
                        // 使用 encodeURIComponent 确保名称在 URL 中安全
                        const query = encodeURIComponent(this.getMainName(item.location));
                        const navUrl = `https://www.google.com/maps/search/?api=1&query=${item.coords[0]},${item.coords[1]}`;

                        const popupContent = `
                            <div style="font-family: sans-serif; min-width: 160px; text-align: left;">
                                <div style="font-size:10px; color:${color}; font-weight:bold; margin-bottom:2px;">
                                    ${item.type === 'food' ? '<i class="fas fa-utensils"></i> 美食' : (item.type === 'shop' ? '<i class="fas fa-shopping-cart"></i> 购物' : item.dayLabel + ' ' + (item.time || ''))}
                                </div>
                                <div style="font-size:13px; font-weight:bold; line-height:1.3;">${this.getMainName(item.location)}</div>
                                <div style="font-size:10px; color:#666; margin-bottom:4px;">${this.getSubName(item.location)}</div>
                                <div style="font-size:11px; color:#444; margin-bottom:8px;">${item.action}</div>
                                <a href="${navUrl}" target="_blank" style="display:block; text-align:center; background:${color}; color:white; text-decoration:none; padding:6px; border-radius:4px; font-size:11px; font-weight:bold;">
                                    <i class="fas fa-location-arrow"></i> 导航
                                </a>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        bounds.push(item.coords);
                    }
                });

                if (bounds.length > 0) {
                    this.mapInstance.fitBounds(bounds, { padding: [50, 50] });
                }
            },
            
            // 样式辅助
            getIconColor(item) {
                if (item.isHotel) return 'bg-purple-500';
                if (item.isGame) return 'bg-red-500 ring-2 ring-red-200';
                if (item.recommend) return 'bg-black border-black'; 
                return 'bg-blue-500';
            },
            isKeyTime(time) { return (time === '17:35' || time === '08:45'); },
            
            // 编辑功能
            openModal(item = null) {
                this.isEditing = !!item;
                this.form = item ? { ...item } : { id: Date.now(), time: '09:00', location: '', action: '', transport_detail: '', coords: [] };
                this.showModal = true;
            },
            saveActivity() {
                if (!this.form.location) return alert('请输入地点');
                if (!this.activities[this.currentDay]) this.activities[this.currentDay] = [];
                if (this.isEditing) {
                    const idx = this.activities[this.currentDay].findIndex(x => x.id === this.form.id);
                    if (idx !== -1) this.activities[this.currentDay][idx] = { ...this.form };
                } else { this.activities[this.currentDay].push({ ...this.form }); }
                this.saveToStorage();
                this.showModal = false;
            },
            deleteActivity() {
                if(confirm('删除此行程？')) {
                    this.activities[this.currentDay] = this.activities[this.currentDay].filter(x => x.id !== this.form.id);
                    this.saveToStorage();
                    this.showModal = false;
                }
            },
            saveToStorage() { localStorage.setItem('japanTrip_v32_Stable', JSON.stringify(this.activities)); },
            resetData() {
                if(confirm('重置将恢复到默认行程，确定吗？')) {
                    this.activities = JSON.parse(JSON.stringify(masterData));
                    this.saveToStorage();
                    this.currentDay = 0;
                    alert('已重置');
                }
            }
        }
    });
    app.mount('#app');
</script>
</body>
</html>
