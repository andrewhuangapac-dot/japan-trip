<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京阪神親子遊 (v37: 雲端相簿版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background-color: #fff7ed; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        #app { height: 100%; display: flex; flex-direction: column; }
        .scroll-container { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; padding-bottom: 90px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #map { height: 100%; width: 100%; z-index: 1; background: #e5e5e5; }
        [v-cloak] { display: none; }
        
        .btn-press { transition: transform 0.1s, opacity 0.1s; }
        .btn-press:active { transform: scale(0.96); opacity: 0.8; }
        
        /* 標籤系統 */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 4px; vertical-align: middle; display: inline-flex; align-items: center; }
        .badge-uber { background: black; color: white; border: 1px solid #333; }
        .badge-hotel { background: #7c3aed; color: white; }
        .badge-game { background: #ef4444; color: white; }
        .badge-train { background: #0284c7; color: white; }
        .badge-walk { background: #16a34a; color: white; }
        
        /* 卡片樣式 */
        .food-card { background-color: #fffbeb; border: 1px solid #fed7aa; border-radius: 12px; padding: 10px; margin-top: 10px; }
        .shop-card { background-color: #fff1f2; border: 1px solid #fda4af; border-radius: 12px; padding: 10px; margin-top: 8px; color: #9f1239; display: block; text-decoration: none; }
        
        .jp-text { font-family: "Hiragino Sans", "Yu Gothic", sans-serif; }
        .location-title { font-size: 16px; line-height: 1.3; font-weight: 700; color: #1c1917; }
        .location-sub { font-size: 12px; color: #57534e; margin-top: 2px; display: block; }
        
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 52px; height: 52px; border-radius: 14px;
            background-color: #292524; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            text-decoration: none; border: 1px solid #444;
        }
        .nav-btn i { font-size: 18px; margin-bottom: 2px; }
        .nav-btn span { font-size: 9px; font-weight: bold; }

        /* Loading Spinner */
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="max-w-md mx-auto bg-white shadow-2xl relative h-full flex flex-col">
    
    <div v-if="isLoading" class="fixed inset-0 bg-black/60 z-[100] flex flex-col items-center justify-center text-white backdrop-blur-sm">
        <div class="w-10 h-10 border-4 border-white/30 border-t-white rounded-full spin mb-3"></div>
        <p class="text-sm font-bold tracking-widest">{{ loadingText }}</p>
    </div>

    <header class="flex-none bg-gradient-to-r from-orange-600 to-red-600 text-white p-5 pb-4 rounded-b-[2rem] shadow-xl z-20">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-xl font-bold tracking-wide">京阪神親子遊 v37</h1>
                <p class="text-orange-100 text-xs mt-1 font-medium">左右滑動切換日期 (雲端版)</p>
            </div>
            <button @click="resetData" class="text-xs bg-white/20 border border-white/30 px-3 py-1.5 rounded-full btn-press backdrop-blur-md">重置</button>
        </div>
        <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1">
            <button v-for="(day, index) in days" :key="index" @click="changeDay(index)"
                :class="currentDay === index ? 'bg-white text-orange-700 font-bold shadow-lg scale-105' : 'bg-orange-800/40 text-orange-100'"
                class="px-3 py-2 rounded-xl text-xs whitespace-nowrap btn-press flex-shrink-0 mb-2 flex flex-col items-center min-w-[4.5rem]">
                <span>{{ day.date }}</span>
                <span class="text-[10px] opacity-80 mt-0.5">{{ day.weather.temp_high }}°</span>
            </button>
        </div>
    </header>

    <main class="scroll-container bg-stone-50" 
          @touchstart="handleTouchStart" 
          @touchend="handleTouchEnd">
        
        <div v-if="currentView === 'list'" class="px-4 pt-4 pb-24 min-h-full">
            <div class="mb-5 bg-white rounded-2xl p-4 shadow-sm border border-stone-200 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-stone-800">{{ days[currentDay].name }}</h2>
                    <div class="flex items-center mt-1 text-sm font-medium" :class="days[currentDay].weather.color">
                        <i :class="days[currentDay].weather.icon" class="mr-2 text-lg"></i>
                        <span>{{ days[currentDay].weather.status }}</span>
                    </div>
                </div>
                <div class="text-[10px] text-stone-400 font-medium">
                    <i class="fas fa-arrows-alt-h mr-1"></i>左右滑換日
                </div>
            </div>

            <div class="space-y-6 transition-all duration-300">
                <div v-for="item in sortedActivities" :key="item.id" class="relative pl-6 border-l-[3px] border-stone-200 last:border-0">
                    <div class="absolute -left-[10px] top-5 w-5 h-5 rounded-full border-4 border-white shadow-sm" :class="getIconColor(item)"></div>
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 mr-3">
                                <div class="flex flex-wrap items-center gap-1 mb-2">
                                    <span class="bg-stone-100 text-stone-600 text-[11px] font-bold px-2 py-0.5 rounded">{{ item.time }}</span>
                                    <span v-if="item.isHotel" class="badge badge-hotel">飯店</span>
                                    <span v-else-if="item.recommend" class="badge badge-uber"><i class="fab fa-uber mr-1"></i>Uber</span>
                                    <span v-else-if="item.transport_mode === 'walking'" class="badge badge-walk"><i class="fas fa-walking mr-1"></i>步行</span>
                                    <span v-else-if="item.transport_mode === 'transit'" class="badge badge-train"><i class="fas fa-train mr-1"></i>地鐵</span>
                                    
                                    <span v-if="item.isGame" class="badge badge-game">必去</span>
                                </div>
                                
                                <div class="mb-2">
                                    <h3 class="location-title jp-text">{{ getMainName(item.location) }}</h3>
                                    <span class="location-sub jp-text">{{ getSubName(item.location) }}</span>
                                </div>
                                <p class="text-stone-600 text-sm font-medium jp-text mb-2">{{ item.action }}</p>
                                
                                <div v-if="item.transport_detail" class="bg-slate-50 border-l-4 border-slate-400 p-2.5 rounded-r-lg mb-3">
                                    <p class="text-[10px] text-slate-500 font-bold mb-0.5"><i class="fas fa-info-circle mr-1"></i>路線建議</p>
                                    <p class="text-[11px] text-slate-700 leading-relaxed whitespace-pre-line">{{ item.transport_detail }}</p>
                                </div>

                                <div class="mb-3">
                                    <div v-if="item.imageUrl" class="relative group mt-2 rounded-lg overflow-hidden border border-stone-200">
                                        <img :src="item.imageUrl" class="w-full h-40 object-cover" @click="viewImage(item.imageUrl)">
                                        <button @click="deleteImage(item)" class="absolute top-2 right-2 bg-red-600/90 text-white w-7 h-7 rounded-full flex items-center justify-center shadow-lg backdrop-blur">
                                            <i class="fas fa-trash-alt text-xs"></i>
                                        </button>
                                    </div>
                                    <div v-else class="mt-2">
                                        <label class="flex items-center justify-center w-full h-10 border-2 border-dashed border-stone-300 rounded-lg bg-stone-50 text-stone-400 cursor-pointer active:bg-stone-100">
                                            <i class="fas fa-camera mr-2"></i>
                                            <span class="text-xs font-bold">上傳照片</span>
                                            <input type="file" accept="image/*" @change="uploadImage($event, item)">
                                        </label>
                                    </div>
                                </div>
                                <div v-if="item.foodOptions" class="food-card">
                                    <p class="text-xs font-bold text-orange-700 mb-2 pb-1 border-b border-orange-100 flex justify-between">
                                        <span><i class="fas fa-utensils mr-1"></i>推薦餐廳 (營業中)</span>
                                    </p>
                                    <div class="space-y-2">
                                        <a v-for="(food, fIdx) in item.foodOptions" :key="fIdx" 
                                           :href="generateGoogleLink(food.query, food.name, 'walking')" 
                                           target="_blank"
                                           class="flex justify-between items-center bg-white p-2 rounded-lg border border-stone-100 shadow-sm btn-press">
                                            <div class="flex-1">
                                                <p class="text-xs font-bold text-gray-800 jp-text">{{ getMainName(food.name) }}</p>
                                                <p class="text-[10px] text-gray-500 mt-0.5">{{ food.desc }}</p>
                                            </div>
                                            <i class="fas fa-location-arrow text-orange-400 text-xs ml-2"></i>
                                        </a>
                                    </div>
                                </div>

                                <a v-if="item.shopping" 
                                   :href="generateGoogleLink(item.shopping.query, item.shopping.name, 'walking')" 
                                   target="_blank"
                                   class="shop-card flex justify-between items-center btn-press">
                                    <div>
                                        <p class="text-xs font-bold jp-text"><i class="fas fa-shopping-bag mr-1"></i>{{ item.shopping.name }}</p>
                                        <p class="text-[10px] opacity-80 mt-0.5">{{ item.shopping.desc }}</p>
                                    </div>
                                    <i class="fas fa-location-arrow text-pink-400 text-xs"></i>
                                </a>
                            </div>

                            <div class="flex flex-col space-y-2 pt-1">
                                <a :href="generateGoogleLink(item.nav_query, item.location, item.transport_mode)" 
                                   target="_blank" 
                                   class="nav-btn btn-press">
                                    <i class="fas fa-location-arrow"></i>
                                    <span>導航</span>
                                </a>
                                <button @click="openModal(item)" class="w-[52px] h-10 rounded-xl bg-stone-100 text-stone-400 flex items-center justify-center btn-press">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentView === 'map'" class="absolute inset-0 z-0 bg-gray-100 h-full w-full">
            <div id="map"></div>
            <button @click="toggleMapMode" class="absolute bottom-24 left-4 z-[500] bg-white text-stone-800 px-4 py-3 rounded-full shadow-xl font-bold text-xs flex items-center border border-stone-200 btn-press">
                <i class="fas mr-2 text-base" :class="showAllMap ? 'fa-map' : 'fa-map-pin'"></i>
                {{ showAllMap ? '顯示全程' : `僅看 Day ${currentDay + 1}` }}
            </button>
        </div>
    </main>

    <nav class="flex-none bg-white/95 backdrop-blur border-t border-stone-100 px-8 py-2 flex justify-between items-center z-30 pb-6 pt-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button @click="currentView = 'list'" :class="currentView === 'list' ? 'text-orange-600' : 'text-stone-300'" class="flex flex-col items-center w-16 btn-press">
            <i class="fas fa-list-ul text-xl mb-1"></i><span class="text-[10px] font-medium">行程</span>
        </button>
        <button @click="openModal()" class="bg-orange-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg shadow-orange-200 -translate-y-6 btn-press border-4 border-stone-50">
            <i class="fas fa-plus text-xl"></i>
        </button>
        <button @click="switchMap" :class="currentView === 'map' ? 'text-orange-600' : 'text-stone-300'" class="flex flex-col items-center w-16 btn-press">
            <i class="fas fa-map-marked-alt text-xl mb-1"></i><span class="text-[10px] font-medium">地圖</span>
        </button>
    </nav>

    <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-stone-900/60 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-bounce-up mb-4 sm:mb-0">
            <h2 class="text-lg font-bold mb-4 text-stone-800">{{ isEditing ? '編輯行程' : '新增行程' }}</h2>
            <div class="space-y-3">
                <input type="time" v-model="form.time" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-sm">
                <input type="text" v-model="form.location" placeholder="地點" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-sm">
                <input type="text" v-model="form.action" placeholder="活動" class="w-full bg-stone-50 border border-stone-200 rounded-xl p-3 text-sm">
            </div>
            <div class="flex gap-3 mt-6">
                <button v-if="isEditing" @click="deleteActivity" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold text-sm btn-press">刪除</button>
                <button @click="showModal = false" class="flex-1 bg-stone-100 text-stone-500 py-3 rounded-xl text-sm btn-press">取消</button>
                <button @click="saveActivity" class="flex-[2] bg-orange-600 text-white py-3 rounded-xl font-bold text-sm btn-press">儲存</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. Firebase 設定 (請填入您的控制台資訊)
    // ==========================================
    const firebaseConfig = {
  apiKey: "AIzaSyByeBl_M9-TjF2i-5D71AjVm5j-vNCbAUc",
  authDomain: "jp-travel-ef684.firebaseapp.com",
  projectId: "jp-travel-ef684",
  storageBucket: "jp-travel-ef684.firebasestorage.app",
  messagingSenderId: "14551021580",
  appId: "1:14551021580:web:586459078e20ac09175629"
    };

    // 初始化 Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const storage = firebase.storage();

    const { createApp } = Vue;
    // v37 Master Data (預設資料)
    const masterDataV36 = {
        0: [
            { id: 101, time: '16:50', location: '關西機場 T2 (Kansai Airport T2)', action: '接駁巴士', transport_detail: '出關後，尋找 "Terminal 1 / Railways" 免費接駁巴士站台。', 
              nav_query: 'Aeroplaza Kansai Airport', transport_mode: 'transit', coords: [34.4357, 135.2443] },
            { id: 102, time: '17:35', location: '關西機場站 (Kansai Airport Station)', action: '搭乘特急 Rapi:t', transport_detail: '南海電鐵 (Nankai Line)，深藍色列車。全車指定席。', 
              nav_query: 'Kansai Airport Station Nankai', transport_mode: 'transit', coords: [34.4367, 135.2435] },
            { id: 103, time: '18:15', location: '南海難波站 (Namba Station)', action: '抵達/出站', transport_detail: '請走 "2F 中央改札口" (2F Central Exit)，下電扶梯往北出口。', 
              nav_query: 'Nankai Namba Station Central Exit', transport_mode: 'walking', coords: [34.6631, 135.5023] },
            { id: 104, time: '18:30', location: 'Caption by Hyatt Namba', action: '飯店 Check-in', isHotel: true, 
              nav_query: 'Caption by Hyatt Namba Osaka', transport_mode: 'walking', coords: [34.6655, 135.5065] },
            { id: 105, time: '19:15', location: '道頓堀 (Dotonbori)', action: '晚餐/逛街', transport_detail: '步行約10分鐘。', 
              nav_query: 'Dotonbori Glico Sign', transport_mode: 'walking', coords: [34.6687, 135.5013], 
              foodOptions: [
                  {name:'一蘭拉麵 道頓堀本館', desc:'24hr 獨立隔間', query:'Ichiran Dotonbori Main Building', coords:[34.6698, 135.5025]}, 
                  {name:'千房大阪燒 道頓堀', desc:'經典大阪燒', query:'Chibo Dotonbori', coords:[34.6685, 135.5032]}, 
                  {name:'藏壽司 道頓堀店', desc:'扭蛋壽司', query:'Kura Sushi Dotonbori', coords:[34.6680, 135.5010]}
              ],
              shopping: {name:'唐吉訶德 (摩天輪店)', desc:'人多，建議速戰速決', query:'Don Quijote Dotonbori', coords:[34.6695, 135.5030]}
            }
        ],
        1: [
            { id: 201, time: '09:00', location: '近鐵日本橋站 (Kintetsu-Nippombashi)', action: '移動至神戶', 
              transport_detail: '搭乘阪神電車 "快速急行" (Rapid Exp.) 往神戶三宮。', 
              nav_query: 'Kintetsu Nippombashi Station', transport_mode: 'transit', coords: [34.6672, 135.5065] },
            { id: 202, time: '11:30', location: '神戶三宮 (Kobe-Sannomiya)', action: '神戶牛午餐', 
              nav_query: 'Steakland Kobe-kan', transport_mode: 'walking', coords: [34.6930, 135.1915], 
              foodOptions: [
                  {name:'Steakland 神戶館', desc:'高CP值', query:'Steakland Kobe-kan', coords:[34.6929, 135.1917]},
                  {name:'Red Rock 本店', desc:'烤牛肉丼', query:'Red Rock Sannomiya', coords:[34.6925, 135.1905]}
              ] 
            },
            { id: 204, time: '14:30', location: 'Mosaic 3F 扭蛋百貨', action: '必去', isGame: true, 
              nav_query: 'Gashapon Department Store Mosaic', transport_mode: 'walking', coords: [34.6795, 135.1843] }
        ],
        2: [
            { id: 301, time: '09:30', location: '黑門市場', action: '早午餐', nav_query: 'Kuromon Market', transport_mode: 'walking', coords: [34.6654, 135.5065] },
            { id: 303, time: '12:30', location: 'Hyatt Place Kyoto', action: 'Check-in', isHotel: true, nav_query: 'Hyatt Place Kyoto', transport_mode: 'driving', coords: [35.0163, 135.7592] },
            { id: 305, time: '15:30', location: 'Nintendo Kyoto', action: '任天堂旗艦店', isGame: true, nav_query: 'Nintendo Kyoto', transport_mode: 'walking', coords: [35.0038, 135.7695] }
        ],
        3: [
            { id: 401, time: '08:30', location: '伏見稻荷大社', action: '千本鳥居', recommend: true, nav_query: 'Fushimi Inari Taisha Parking Lot', transport_mode: 'driving', coords: [34.9671, 135.7726] },
            { id: 402, time: '10:30', location: '清水寺', action: '移動', recommend: true, nav_query: 'Kiyomizu-michi Bus Stop', transport_mode: 'driving', coords: [34.9949, 135.7850] }
        ],
        4: [
            { id: 501, time: '08:05', location: '京都站 八條口', action: '前往車站', recommend: true, nav_query: 'Kyoto Station Hachijo Exit', transport_mode: 'driving', coords: [34.9850, 135.7580] },
            { id: 503, time: '10:05', location: '關西機場 T1', action: '登機', nav_query: 'Kansai Airport', transport_mode: 'walking', coords: [34.4357, 135.2443] }
        ]
    };

    const app = createApp({
        data() {
            return {
                currentDay: 0,
                currentView: 'list',
                showModal: false,
                isEditing: false,
                showAllMap: true, 
                mapInstance: null,
                markerGroup: null,
                isLoading: false, // UI Loading 狀態
                loadingText: '讀取中...',
                touchStartX: 0,
                touchStartY: 0,
                touchEndX: 0,
                touchEndY: 0,
                days: [
                    { date: '12/12', name: 'Day 1: 大阪', weather: { status: '晴', icon: 'fas fa-sun', temp_high: 11, color: 'text-orange-500' } },
                    { date: '12/13', name: 'Day 2: 神戶', weather: { status: '陰', icon: 'fas fa-cloud', temp_high: 11, color: 'text-gray-500' } },
                    { date: '12/14', name: 'Day 3: 京都', weather: { status: '雨', icon: 'fas fa-cloud-rain', temp_high: 14, color: 'text-blue-500' } },
                    { date: '12/15', name: 'Day 4: 清水', weather: { status: '多雲', icon: 'fas fa-cloud', temp_high: 11, color: 'text-gray-500' } },
                    { date: '12/16', name: 'Day 5: 返程', weather: { status: '晴', icon: 'fas fa-sun', temp_high: 12, color: 'text-orange-500' } }
                ],
                activities: {},
                form: { id: null, time: '', location: '', action: '', transport_detail: '', coords: [] }
            }
        },
        computed: {
            currentActivities() { return this.activities[this.currentDay] || []; },
            sortedActivities() { return [...this.currentActivities].sort((a, b) => a.time.localeCompare(b.time)); }
        },
        mounted() { this.loadAndMergeData(); },
        methods: {
            getMainName(str) { return str ? str.split('(')[0] : ''; },
            getSubName(str) { 
                if(!str) return '';
                const match = str.match(/\(([^)]+)\)/);
                return match ? match[1] : '';
            },
            
            // --- 觸摸滑動 (Swipe) ---
            handleTouchStart(e) {
                if(this.currentView !== 'list') return;
                this.touchStartX = e.changedTouches[0].screenX;
                this.touchStartY = e.changedTouches[0].screenY;
            },
            handleTouchEnd(e) {
                if(this.currentView !== 'list') return;
                this.touchEndX = e.changedTouches[0].screenX;
                this.touchEndY = e.changedTouches[0].screenY;
                this.handleSwipe();
            },
            handleSwipe() {
                const diffX = this.touchStartX - this.touchEndX;
                const diffY = this.touchStartY - this.touchEndY;
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) { // 左滑 -> 下一天
                        if (this.currentDay < this.days.length - 1) this.changeDay(this.currentDay + 1);
                    } else { // 右滑 -> 上一天
                        if (this.currentDay > 0) this.changeDay(this.currentDay - 1);
                    }
                }
            },

            // --- ★ 雲端資料庫同步 (Firebase Database) ---
            loadAndMergeData() {
                this.isLoading = true;
                this.loadingText = "正在同步雲端行程...";
                const tripRef = db.ref('my_trip_v37'); // 改變路徑避免衝突

                tripRef.on('value', (snapshot) => {
                    const cloudData = snapshot.val();
                    if (cloudData) {
                        this.activities = cloudData;
                    } else {
                        // 初始化：若雲端是空的，用本地 masterData 填入
                        this.activities = JSON.parse(JSON.stringify(masterDataV36));
                        this.saveToStorage();
                    }
                    this.isLoading = false;
                });
            },
            
            saveToStorage() {
                // 將數據寫回 Firebase
                db.ref('my_trip_v37').set(this.activities)
                    .then(() => console.log("Saved to Cloud"))
                    .catch(err => alert("同步失敗: " + err.message));
            },

            // --- ★ 照片上傳功能 (Firebase Storage) ---
            uploadImage(event, item) {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    alert("照片過大 (請小於 5MB)");
                    return;
                }

                this.isLoading = true;
                this.loadingText = "照片上傳中...";

                // 1. 建立路徑: trip_photos/時間戳_檔名
                const fileName = `${Date.now()}_${file.name}`;
                const filePath = `trip_photos/${fileName}`;
                const storageRef = storage.ref().child(filePath);

                // 2. 上傳
                storageRef.put(file).then(snapshot => {
                    return snapshot.ref.getDownloadURL();
                }).then(downloadURL => {
                    // 3. 更新數據
                    item.imageUrl = downloadURL;
                    item.storagePath = filePath; // 存路徑以便刪除
                    
                    // 4. 同步資料庫
                    this.saveToStorage();
                    this.isLoading = false;
                }).catch(error => {
                    console.error(error);
                    alert("上傳失敗: " + error.message);
                    this.isLoading = false;
                });
            },

            deleteImage(item) {
                if (!confirm("確定刪除這張照片？")) return;
                this.isLoading = true;
                this.loadingText = "刪除中...";

                // 1. 刪除雲端檔案
                if (item.storagePath) {
                    storage.ref().child(item.storagePath).delete().catch(err => console.log("檔案可能已不在"));
                }

                // 2. 清除連結並存檔
                item.imageUrl = null;
                item.storagePath = null;
                this.saveToStorage();
                this.isLoading = false;
            },

            viewImage(url) {
                window.open(url, '_blank');
            },

            // --- 地圖與連結邏輯 (保持不變) ---
            generateGoogleLink(query, fallbackName, mode) {
                let q = query || fallbackName;
                if (!q) return '#';
                const encodedQ = encodeURIComponent(q);
                if (mode === 'walking' && !query.includes('Station')) {
                     return `https://www.google.com/maps/search/?api=1&query=${encodedQ}`;
                }
                return `https://www.google.com/maps/dir/?api=1&destination=${encodedQ}&travelmode=${mode}`;
            },

            changeDay(index) {
                this.currentDay = index;
                this.currentView = 'list';
                this.showAllMap = false; 
                const container = document.querySelector('.scroll-container');
                if(container) container.scrollTop = 0;
                if (this.mapInstance) this.$nextTick(() => { this.updateMapMarkers(); });
            },
            switchMap() {
                this.currentView = 'map';
                this.showAllMap = true; 
                this.$nextTick(() => {
                    if (!this.mapInstance) this.initMap();
                    else { this.mapInstance.invalidateSize(); this.updateMapMarkers(); }
                });
            },
            toggleMapMode() {
                this.showAllMap = !this.showAllMap;
                this.updateMapMarkers();
            },
            initMap() {
                this.mapInstance = L.map('map');
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap', maxZoom: 19 }).addTo(this.mapInstance);
                this.markerGroup = L.layerGroup().addTo(this.mapInstance);
                this.updateMapMarkers();
            },
            updateMapMarkers() {
                if (!this.mapInstance || !this.markerGroup) return;
                this.markerGroup.clearLayers();
                let actsToShow = [];
                const bounds = [];
                
                const getItemsForDay = (dayIndex) => {
                    const items = [];
                    if (this.activities[dayIndex]) {
                        this.activities[dayIndex].forEach(act => {
                            if(act.coords) items.push({ ...act, type: 'main' });
                            if (act.foodOptions) act.foodOptions.forEach(f => items.push({ coords: f.coords, location: f.name, action: f.desc, type: 'food', nav_query: f.query }));
                            if (act.shopping) items.push({ coords: act.shopping.coords, location: act.shopping.name, action: act.shopping.desc, type: 'shop', nav_query: act.shopping.query });
                        });
                    }
                    return items;
                };

                if (this.showAllMap) Object.keys(this.activities).forEach(key => actsToShow = actsToShow.concat(getItemsForDay(key)));
                else actsToShow = getItemsForDay(this.currentDay);

                actsToShow.forEach(item => {
                    if (item.coords) {
                        let color = item.type === 'food' ? '#f97316' : (item.type === 'shop' ? '#ef4444' : (item.isHotel ? '#8b5cf6' : '#3b82f6'));
                        const marker = L.circleMarker(item.coords, { color: color, fillColor: color, fillOpacity: 0.8, radius: 8, weight: 2 }).addTo(this.markerGroup);
                        
                        const mapUrl = this.generateGoogleLink(item.nav_query || this.getMainName(item.location), this.getMainName(item.location), 'walking');
                        
                        marker.bindPopup(`
                            <div style="font-family:sans-serif; min-width:150px;">
                                <div style="font-weight:bold; color:${color}">${this.getMainName(item.location)}</div>
                                <div style="font-size:12px; margin:4px 0;">${item.action}</div>
                                <a href="${mapUrl}" target="_blank" style="display:block; text-align:center; background:${color}; color:white; padding:6px; border-radius:4px; text-decoration:none; font-size:12px; margin-top:5px;">Google Maps 導航</a>
                            </div>
                        `);
                        bounds.push(item.coords);
                    }
                });
                if (bounds.length > 0) this.mapInstance.fitBounds(bounds, { padding: [50, 50] });
            },
            getIconColor(item) {
                if (item.isHotel) return 'bg-purple-500';
                if (item.isGame) return 'bg-red-500 ring-2 ring-red-200';
                if (item.recommend) return 'bg-black border-black'; 
                return 'bg-blue-500';
            },
            openModal(item = null) {
                this.isEditing = !!item;
                this.form = item ? { ...item } : { id: Date.now(), time: '09:00', location: '', action: '', transport_detail: '', coords: [] };
                this.showModal = true;
            },
            saveActivity() {
                if (!this.form.location) return alert('請輸入地點');
                if (!this.activities[this.currentDay]) this.activities[this.currentDay] = [];
                if (this.isEditing) {
                    const idx = this.activities[this.currentDay].findIndex(x => x.id === this.form.id);
                    if (idx !== -1) {
                        // 保留原本的照片連結，除非被編輯掉
                        const original = this.activities[this.currentDay][idx];
                        this.activities[this.currentDay][idx] = { 
                            ...this.form, 
                            imageUrl: original.imageUrl, 
                            storagePath: original.storagePath 
                        };
                    }
                } else { 
                    this.activities[this.currentDay].push({ ...this.form, imageUrl: null }); 
                }
                this.saveToStorage();
                this.showModal = false;
            },
            deleteActivity() {
                if(confirm('刪除此行程？')) {
                    // 若有照片也順便刪除
                    const item = this.activities[this.currentDay].find(x => x.id === this.form.id);
                    if(item && item.imageUrl) {
                        this.deleteImage(item); // 這會觸發儲存，但下面會覆蓋，沒關係
                    }
                    this.activities[this.currentDay] = this.activities[this.currentDay].filter(x => x.id !== this.form.id);
                    this.saveToStorage();
                    this.showModal = false;
                }
            },
            resetData() {
                if(confirm('警告：確定重置行程？所有自訂修改和照片連結將會遺失 (但雲端照片檔案需手動清理)。')) {
                    this.activities = JSON.parse(JSON.stringify(masterDataV36));
                    this.saveToStorage();
                    this.currentDay = 0;
                }
            }
        }
    });
    app.mount('#app');
</script>
</body>
</html>
