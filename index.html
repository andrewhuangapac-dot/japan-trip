<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¬éƒ½å¤§é˜ªä¹‹æ—… (é›²ç«¯ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ (èˆ‡ä¹‹å‰ç›¸åŒï¼Œå¢åŠ  Loading) --- */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; }
        .justify-between { justify-content: space-between; } .w-full { width: 100%; } .h-64 { height: 16rem; }
        .fixed { position: fixed; } .absolute { position: absolute; } .relative { position: relative; }
        .top-0 { top: 0; } .bottom-0 { bottom: 0; } .z-50 { z-index: 50; }
        .bg-blue-600 { background-color: #2563eb; } .text-white { color: white; }
        .p-4 { padding: 1rem; } .m-2 { margin: 0.5rem; } .rounded-lg { border-radius: 0.5rem; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .hidden { display: none; }

        /* ç…§ç‰‡æ¨£å¼ */
        .trip-image { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .upload-btn { background: #eff6ff; color: #2563eb; padding: 8px; border-radius: 6px; text-align: center; font-size: 0.9rem; font-weight: bold; cursor: pointer; border: 1px dashed #bfdbfe; }
        
        /* Loading é®ç½© */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal & Input */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 60; display: flex; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; width: 100%; max-width: 450px; border-radius: 1rem 1rem 0 0; padding: 1.5rem; animation: slideUp 0.3s; }
        .input-field { width: 100%; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid #ddd; border-radius: 0.5rem; box-sizing: border-box; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen relative shadow-lg">
        
        <div v-if="isLoading" class="loading-overlay">
            <div class="spinner"></div>
            <p class="mt-2 text-blue-600 font-bold">è³‡æ–™åŒæ­¥ä¸­...</p>
        </div>

        <header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-cloud"></i> äº¬éƒ½é›²ç«¯ç‰ˆ</h1>
            <div class="text-xs opacity-80">å·²é€£æ¥ Firebase</div>
        </header>

        <div class="relative w-full h-64 z-10">
            <div id="map" class="w-full h-full"></div>
        </div>

        <div class="flex overflow-x-auto bg-white border-b border-gray-200 p-2 sticky top-16 z-40">
            <button v-for="day in days" :key="day" @click="currentDay = day"
                :class="['px-4 py-2 m-1 rounded-full text-sm font-bold whitespace-nowrap', currentDay === day ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600']">
                {{ day }}
            </button>
        </div>

        <div class="p-2 pb-20 space-y-4">
            <div v-for="item in filteredActivities" :key="item.id" class="bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-600 relative">
                <div class="flex justify-between">
                    <div>
                        <span class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded">{{ item.time }}</span>
                        <h3 class="font-bold text-lg inline ml-2">{{ item.location }}</h3>
                    </div>
                    <div>
                        <button @click="locateOnMap(item)" class="text-blue-600 p-2"><i class="fas fa-map-marker-alt"></i></button>
                        <button @click="deleteItem(item)" class="text-red-600 p-2"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <p class="text-gray-600 text-sm mt-2 bg-gray-50 p-2 rounded">{{ item.note }}</p>

                <div v-if="item.imageUrl" class="relative mt-2">
                    <img :src="item.imageUrl" class="trip-image" @click="viewImage(item.imageUrl)">
                    <button @click="deleteImage(item)" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full shadow"><i class="fas fa-times"></i></button>
                </div>
                <div v-else class="mt-2">
                    <label class="upload-btn block">
                        <i class="fas fa-camera mr-1"></i> ä¸Šå‚³é«˜æ¸…ç…§ç‰‡
                        <input type="file" accept="image/*" class="hidden" @change="uploadImage($event, item)">
                    </label>
                </div>
            </div>
            
            <div v-if="filteredActivities.length === 0" class="text-center text-gray-400 py-10">
                <i class="fas fa-wind text-4xl mb-2"></i><p>é€™è£¡ç©ºç©ºå¦‚ä¹Ÿ</p>
            </div>
        </div>

        <button @click="showModal = true" class="fixed bottom-20 right-4 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg text-2xl z-40 flex justify-center items-center">
            <i class="fas fa-plus"></i>
        </button>

        <div v-if="showModal" class="modal-bg" @click.self="showModal = false">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">æ–°å¢è¡Œç¨‹</h2>
                <select v-model="form.day" class="input-field"><option v-for="d in days" :value="d">{{ d }}</option></select>
                <div class="flex gap-2">
                    <input type="time" v-model="form.time" class="input-field">
                    <input type="text" v-model="form.location" placeholder="åœ°é»åç¨±" class="input-field">
                </div>
                <textarea v-model="form.note" placeholder="å‚™è¨»..." class="input-field" rows="3"></textarea>
                <button @click="addItem" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-2">ä¿å­˜</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import * as L from 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js';
        
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ==========================================
        // ğŸ”´ 1. è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ Firebase Config
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyByeBl_M9-TjF2i-5D71AjVm5j-vNCbAUc",
  authDomain: "jp-travel-ef684.firebaseapp.com",
  projectId: "jp-travel-ef684",
  storageBucket: "jp-travel-ef684.firebasestorage.app",
  messagingSenderId: "14551021580",
  appId: "1:14551021580:web:586459078e20ac09175629"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const TRIPS_COLLECTION = "trips"; // è³‡æ–™åº«é›†åˆåç¨±

        createApp({
            setup() {
                const days = ['Day 1 (12/12)', 'Day 2 (12/13)', 'Day 3 (12/14)', 'Day 4 (12/15)'];
                const currentDay = ref(days[0]);
                const activities = ref([]);
                const showModal = ref(false);
                const isLoading = ref(false);
                const form = ref({ day: days[0], time: '12:00', location: '', note: '' });
                let map = null;
                let markers = [];

                // --- è³‡æ–™åº«æ“ä½œ (Firestore) ---
                
                // è®€å–è³‡æ–™
                const fetchActivities = async () => {
                    isLoading.value = true;
                    try {
                        const q = query(collection(db, TRIPS_COLLECTION)); // é€™è£¡å¯ä»¥åŠ  orderBy
                        const querySnapshot = await getDocs(q);
                        activities.value = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateMap();
                    } catch (e) {
                        console.error("è®€å–éŒ¯èª¤", e);
                        alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯");
                    }
                    isLoading.value = false;
                };

                // æ–°å¢è³‡æ–™
                const addItem = async () => {
                    if (!form.value.location) return;
                    isLoading.value = true;
                    try {
                        // æ¨¡æ“¬åº§æ¨™ (å¯¦éš›å¯ç”¨ API ç²å–)
                        const mockLat = 34.9858 + (Math.random() - 0.5) * 0.05;
                        const mockLng = 135.7588 + (Math.random() - 0.5) * 0.05;

                        const newItem = { 
                            ...form.value, 
                            lat: mockLat, 
                            lng: mockLng,
                            imageUrl: null,
                            createdAt: Date.now() 
                        };

                        await addDoc(collection(db, TRIPS_COLLECTION), newItem);
                        showModal.value = false;
                        fetchActivities(); // é‡æ–°è®€å–
                        
                        // é‡ç½®è¡¨å–®
                        form.value = { day: currentDay.value, time: '12:00', location: '', note: '' };
                    } catch (e) {
                        alert("æ–°å¢å¤±æ•—: " + e.message);
                    }
                    isLoading.value = false;
                };

                // åˆªé™¤è³‡æ–™ (é€£åŒåœ–ç‰‡ä¸€èµ·åˆª)
                const deleteItem = async (item) => {
                    if (!confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) return;
                    isLoading.value = true;
                    try {
                        // å¦‚æœæœ‰åœ–ç‰‡ï¼Œå…ˆåˆªé™¤ Storage è£¡çš„åœ–
                        if (item.imageUrl) {
                            await deleteImage(item, false); // false = ä¸è¦è§¸ç™¼ UI æ›´æ–°ï¼Œå› ç‚ºä¸‹é¢æœƒåˆªé™¤æ•´æ¢
                        }
                        // åˆªé™¤ Firestore æ–‡ä»¶
                        await deleteDoc(doc(db, TRIPS_COLLECTION, item.id));
                        // å¾æœ¬åœ°åˆ—è¡¨ç§»é™¤
                        activities.value = activities.value.filter(a => a.id !== item.id);
                        updateMap();
                    } catch (e) {
                        alert("åˆªé™¤å¤±æ•—");
                    }
                    isLoading.value = false;
                };

                // --- åœ–ç‰‡æ“ä½œ (Storage) ---

                const uploadImage = async (event, item) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    isLoading.value = true;
                    try {
                        // 1. å»ºç«‹å„²å­˜è·¯å¾‘ï¼š trips/æ–‡ä»¶ID_æ™‚é–“æˆ³.jpg
                        const storagePath = `trips/${item.id}_${Date.now()}.jpg`;
                        const storageRef = sRef(storage, storagePath);

                        // 2. ä¸Šå‚³æª”æ¡ˆ
                        const snapshot = await uploadBytes(storageRef, file);

                        // 3. ç²å–å…¬é–‹ç¶²å€
                        const downloadURL = await getDownloadURL(snapshot.ref);

                        // 4. æ›´æ–° Firestore è³‡æ–™åº«
                        const itemRef = doc(db, TRIPS_COLLECTION, item.id);
                        await updateDoc(itemRef, { 
                            imageUrl: downloadURL,
                            storagePath: storagePath // å­˜è·¯å¾‘æ˜¯ç‚ºäº†æ–¹ä¾¿ä¹‹å¾Œåˆªé™¤
                        });

                        // 5. æ›´æ–°æœ¬åœ°è¦–åœ–
                        item.imageUrl = downloadURL;
                        item.storagePath = storagePath;

                    } catch (e) {
                        console.error(e);
                        alert("åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼š" + e.message);
                    }
                    isLoading.value = false;
                };

                const deleteImage = async (item, updateUI = true) => {
                    if (updateUI && !confirm("ç¢ºå®šåˆªé™¤ç…§ç‰‡ï¼Ÿ")) return;
                    
                    isLoading.value = true;
                    try {
                        // åˆªé™¤é›²ç«¯æª”æ¡ˆ
                        if (item.storagePath) {
                            const fileRef = sRef(storage, item.storagePath);
                            await deleteObject(fileRef).catch(err => console.log("åœ–ç‰‡å¯èƒ½å·²ä¸å­˜åœ¨"));
                        }

                        // æ›´æ–°è³‡æ–™åº«è¨­ç‚º null
                        const itemRef = doc(db, TRIPS_COLLECTION, item.id);
                        await updateDoc(itemRef, { imageUrl: null, storagePath: null });

                        if (updateUI) {
                            item.imageUrl = null;
                            item.storagePath = null;
                        }
                    } catch (e) {
                        console.error(e);
                        alert("åˆªé™¤ç…§ç‰‡å¤±æ•—");
                    }
                    isLoading.value = false;
                };

                // --- åœ°åœ–èˆ‡å·¥å…· ---
                const filteredActivities = computed(() => {
                    return activities.value
                        .filter(i => i.day === currentDay.value)
                        .sort((a, b) => a.time.localeCompare(b.time));
                });

                const initMap = () => {
                    map = L.map('map').setView([34.9858, 135.7588], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);
                };

                const updateMap = () => {
                    if (!map) return;
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];
                    filteredActivities.value.forEach(item => {
                        if (item.lat && item.lng) {
                            const m = L.marker([item.lat, item.lng]).addTo(map).bindPopup(item.location);
                            markers.push(m);
                        }
                    });
                };

                const locateOnMap = (item) => {
                    map.setView([item.lat, item.lng], 15);
                    // ç°¡å–®é–‹å•Ÿå°æ‡‰ Popup
                    markers.forEach(m => {
                        const ll = m.getLatLng();
                        if (Math.abs(ll.lat - item.lat) < 0.0001) m.openPopup();
                    });
                };

                const viewImage = (url) => {
                    window.open(url, '_blank');
                };

                // Watchers & Mount
                watch(currentDay, updateMap);
                
                onMounted(() => {
                    initMap();
                    fetchActivities();
                });

                return {
                    days, currentDay, activities, showModal, form, isLoading,
                    filteredActivities, addItem, deleteItem, uploadImage, deleteImage,
                    locateOnMap, viewImage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
