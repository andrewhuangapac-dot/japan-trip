<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¬é˜ªç¥å®¶æ—ä¹‹æ—… 2025</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; -webkit-tap-highlight-color: transparent; }
        
        .app-container { max-width: 430px; margin: 0 auto; background: white; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
        
        .timeline-line { position: absolute; left: 24px; top: 30px; bottom: -20px; width: 2px; background: #e5e7eb; z-index: 0; }
        .last-item .timeline-line { display: none; }
        
        #map { height: 100%; width: 100%; z-index: 0; }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px; }
        .photo-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; position: relative; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="!isAccessGranted" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 text-center shadow-2xl">
            <div class="mb-4 text-4xl">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
            <h2 class="text-xl font-bold mb-2">å®¶æ—æ—…ç¨‹é–å®šä¸­</h2>
            <p class="text-gray-500 text-sm mb-6">è«‹è¼¸å…¥é€šè¡Œç¢¼ (Hint: Alfred)</p>
            <input type="password" v-model="passcode" class="w-full text-center text-xl border-b-2 border-blue-500 py-2 mb-6 outline-none focus:border-blue-700" placeholder="Passcode">
            <button @click="checkPasscode" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold active:scale-95 transition shadow-lg shadow-blue-500/30">è§£é–è¡Œç¨‹</button>
        </div>
    </div>

    <div v-else class="app-container">
        <header class="bg-white/95 backdrop-blur-md sticky top-0 z-40 border-b border-gray-100 pb-2">
            <div class="px-5 pt-12 pb-2 flex justify-between items-end">
                <div>
                    <div class="text-xs text-blue-600 font-bold tracking-wider mb-1">FAMILY TRIP 2025</div>
                    <h1 class="text-2xl font-bold text-slate-800">äº¬é˜ªç¥å®¶æ—ä¹‹æ—… ğŸ‡¯ğŸ‡µ</h1>
                </div>
                <div class="flex gap-3">
                    <button @click="downloadMemories" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-blue-600 hover:bg-blue-50 transition">
                        <i class="fas fa-cloud-download-alt"></i>
                    </button>
                    <button @click="resetData" class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-red-500 hover:bg-red-50 transition">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>

            <div class="flex overflow-x-auto px-4 pb-2 gap-3 scroll-container snap-x">
                <div v-for="(day, index) in days" :key="index" 
                     @click="changeDay(index)"
                     class="snap-center flex-shrink-0 flex flex-col items-center justify-center w-[72px] h-[85px] rounded-2xl transition-all duration-300 border cursor-pointer"
                     :class="currentDay === index ? 'bg-blue-600 text-white border-blue-600 shadow-lg scale-105' : 'bg-white text-gray-400 border-gray-100'">
                    
                    <span class="text-xs font-medium">{{ day.date }}</span>
                    <span class="text-sm font-bold my-0.5">{{ day.weekday }}</span>
                    
                    <div class="mt-1 flex flex-col items-center">
                        <i :class="[day.weather.icon, currentDay === index ? 'text-white' : day.weather.color]" class="text-sm"></i>
                        <span class="text-[10px] mt-0.5" :class="currentDay === index ? 'text-blue-100' : 'text-gray-400'">
                            {{ day.weather.temp_high !== '-' ? day.weather.temp_high + 'Â°' : '--' }}
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto scroll-container relative bg-white" 
              @touchstart="handleTouchStart" @touchend="handleTouchEnd">
            
            <div v-if="isLoading" class="absolute inset-0 z-30 bg-white/80 backdrop-blur flex flex-col items-center justify-center">
                <div class="animate-spin text-blue-600 text-3xl mb-3"><i class="fas fa-circle-notch"></i></div>
                <div class="text-sm text-gray-500 font-medium">{{ loadingText }}</div>
                <div v-if="progress > 0" class="w-32 h-1 bg-gray-200 rounded-full mt-3 overflow-hidden">
                    <div class="h-full bg-blue-500 transition-all duration-300" :style="{width: progress + '%'}"></div>
                </div>
            </div>

            <div v-if="currentView === 'list'" class="px-5 py-6 pb-24">
                <div v-if="sortedActivities.length === 0" class="text-center py-20 text-gray-400">
                    <p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                    <button @click="openModal()" class="mt-4 text-blue-600 text-sm font-bold">ç«‹å³æ–°å¢</button>
                </div>

                <div v-for="(item, idx) in sortedActivities" :key="item.id" 
                     class="relative pl-12 pb-8 group" 
                     :class="{'last-item': idx === sortedActivities.length - 1}">
                    
                    <div class="timeline-line"></div>
                    
                    <div class="absolute left-0 top-1 w-12 text-xs font-bold text-gray-400 text-right pr-4">{{ item.time }}</div>
                    <div class="absolute left-[18px] top-1 w-3 h-3 rounded-full border-2 border-white shadow-sm z-10"
                         :class="getIconColor(item)"></div>

                    <div @click="openModal(item)" class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 active:scale-[0.99] transition-transform duration-200">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">{{ getMainName(item.location) }}</h3>
                            <div class="flex gap-2">
                                <a v-if="item.coords" :href="generateGoogleLink(item.location, item.location, item.transport_mode)" target="_blank" @click.stop class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xs hover:bg-blue-100 transition">
                                    <i class="fas fa-location-arrow"></i>
                                </a>
                            </div>
                        </div>
                        
                        <p v-if="getSubName(item.location)" class="text-xs text-gray-400 mb-2">{{ getSubName(item.location) }}</p>
                        
                        <div class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium mb-3"
                             :class="item.isHotel ? 'bg-purple-100 text-purple-700' : (item.isGame ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-600')">
                            <i class="mr-1.5" :class="item.isHotel ? 'fas fa-bed' : (item.isGame ? 'fas fa-gamepad' : 'fas fa-walking')"></i>
                            {{ item.action }}
                        </div>

                        <div v-if="item.foodOptions && item.foodOptions.length > 0" class="mt-2 mb-2 bg-orange-50/50 rounded-xl p-3 border border-orange-100" @click.stop>
                            <div class="px-1 mb-2 flex items-center gap-1.5 text-xs font-bold text-orange-600">
                                <i class="fas fa-utensils"></i> é™„è¿‘å®¶åº­ç¾é£Ÿæ¨è–¦
                            </div>
                            
                            <div class="flex flex-col gap-2">
                                <div v-for="(food, fIdx) in item.foodOptions" :key="fIdx" 
                                     class="bg-white p-3 rounded-lg border border-orange-100 shadow-sm flex justify-between items-center">
                                     
                                     <div class="flex-1 min-w-0 mr-3">
                                        <div class="font-bold text-gray-800 text-sm mb-0.5 truncate">{{ food.name }}</div>
                                        <div class="text-[11px] text-gray-500 leading-tight">{{ food.desc }}</div>
                                     </div>
                                     
                                     <a :href="generateGoogleLink(food.query, food.name, 'walking')" target="_blank" 
                                        class="shrink-0 w-8 h-8 flex items-center justify-center bg-orange-50 text-orange-600 rounded-full text-xs active:scale-95 transition">
                                        <i class="fas fa-location-arrow"></i>
                                     </a>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="photo-grid" v-if="item.images && item.images.length">
                                <div v-for="(img, imgIdx) in item.images" :key="imgIdx" class="photo-item bg-gray-100" @click.stop="viewImage(img.url)">
                                    <img :src="img.url" loading="lazy">
                                    <button @click.stop="deleteSingleImage(item, imgIdx)" class="absolute top-1 right-1 bg-black/50 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px]">âœ•</button>
                                </div>
                            </div>
                            
                            <label class="mt-3 flex items-center gap-2 text-xs text-gray-400 py-2 cursor-pointer hover:text-blue-500 transition w-fit" @click.stop>
                                <i class="fas fa-camera"></i>
                                <span>æ–°å¢ç…§ç‰‡</span>
                                <input type="file" multiple accept="image/*" class="hidden" @change="uploadImages($event, item)">
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentView === 'map'" class="h-full w-full relative">
                <div id="map"></div>
                <div class="absolute bottom-24 right-4 z-[400] flex flex-col gap-2">
                    <button @click="toggleMapMode" class="w-12 h-12 bg-white rounded-full shadow-lg text-gray-700 flex items-center justify-center font-bold text-xs border border-gray-200">
                        {{ showAllMap ? 'All' : 'Day' }}
                    </button>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-3 flex justify-around items-center z-50 max-w-[430px] mx-auto pb-safe">
            <button @click="changeDay(currentDay)" class="flex flex-col items-center gap-1 transition" :class="currentView === 'list' ? 'text-blue-600' : 'text-gray-300'">
                <i class="fas fa-list-ul text-xl"></i>
                <span class="text-[10px] font-medium">è¡Œç¨‹</span>
            </button>
            
            <button @click="openModal()" class="w-14 h-14 bg-blue-600 rounded-full shadow-lg shadow-blue-200 flex items-center justify-center text-white text-2xl -mt-8 border-4 border-white active:scale-95 transition hover:bg-blue-700">
                <i class="fas fa-plus"></i>
            </button>
            
            <button @click="switchMap" class="flex flex-col items-center gap-1 transition" :class="currentView === 'map' ? 'text-blue-600' : 'text-gray-300'">
                <i class="fas fa-map-marked-alt text-xl"></i>
                <span class="text-[10px] font-medium">åœ°åœ–</span>
            </button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="showModal = false"></div>
            <div class="bg-white w-full sm:max-w-sm sm:rounded-2xl rounded-t-2xl p-6 relative z-10 animate-slide-up shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-gray-800">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-1">
                            <label class="text-xs text-gray-500 font-bold ml-1 mb-1 block">æ™‚é–“</label>
                            <input type="time" v-model="form.time" class="w-full bg-gray-50 border-0 rounded-xl px-3 py-3 text-sm font-bold focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-gray-500 font-bold ml-1 mb-1 block">åœ°é»åç¨±</label>
                            <input type="text" v-model="form.location" placeholder="ä¾‹å¦‚: æ¸…æ°´å¯º" class="w-full bg-gray-50 border-0 rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 font-bold ml-1 mb-1 block">æ´»å‹•å…§å®¹ / å‚™è¨»</label>
                        <input type="text" v-model="form.action" placeholder="ä¾‹å¦‚: ç©¿å’Œæœæ‹ç…§" class="w-full bg-gray-50 border-0 rounded-xl px-3 py-3 text-sm focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button v-if="isEditing" @click="deleteActivity" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold text-sm">åˆªé™¤</button>
                        <button @click="saveActivity" class="flex-[2] bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-200">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Firebase åˆå§‹åŒ–
    const firebaseConfig = {
        apiKey: "AIzaSyByeBl_M9-TjF2i-5D71AjVm5j-vNCbAUc",
        authDomain: "jp-travel-ef684.firebaseapp.com",
        databaseURL: "https://jp-travel-ef684-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "jp-travel-ef684",
        storageBucket: "jp-travel-ef684.firebasestorage.app",
        messagingSenderId: "14551021580",
        appId: "1:14551021580:web:586459078e20ac09175629"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const storage = firebase.storage();

    const { createApp } = Vue;

    // 2. å®Œæ•´è¡Œç¨‹èˆ‡é¤å»³è³‡æ–™ (å·²é‡å° 2å¤§2å° 9/12æ­²å„ªåŒ–)
    const masterDataVFinal = {
       0: [
           { id: 101, time: '16:50', location: 'å…³è¥¿æœºåœº T2 (Kansai Airport T2)', action: 'æ¥é©³å·´å£«', transport_detail: 'å‡ºå…³åï¼Œå¯»æ‰¾ "Terminal 1 / Railways" å…è´¹æ¥é©³å·´å£«ç«™å°ã€‚', 
             nav_query: 'Aeroplaza Kansai Airport', transport_mode: 'transit', coords: [34.4357, 135.2443] },
           { id: 102, time: '17:35', location: 'å…³è¥¿æœºåœºç«™ (Kansai Airport Station)', action: 'æ­ä¹˜ç‰¹æ€¥ Rapi:t', transport_detail: 'å—æµ·ç”µé“ (Nankai Line)ï¼Œæ·±è“è‰²åˆ—è½¦ã€‚å…¨è½¦æŒ‡å®šå¸­ã€‚', 
             nav_query: 'Kansai Airport Station Nankai', transport_mode: 'transit', coords: [34.4367, 135.2435] },
           { id: 103, time: '18:15', location: 'å—æµ·éš¾æ³¢ç«™ (Namba Station)', action: 'æŠµè¾¾/å‡ºç«™', transport_detail: 'è¯·èµ° "2F ä¸­å¤®æ”¹æœ­å£" (2F Central Exit)ï¼Œä¸‹ç”µæ‰¶æ¢¯å¾€åŒ—å‡ºå£ã€‚', 
             nav_query: 'Nankai Namba Station Central Exit', transport_mode: 'walking', coords: [34.6631, 135.5023] },
           { id: 104, time: '18:30', location: 'Caption by Hyatt Namba', action: 'é¥­åº— Check-in', isHotel: true, 
             nav_query: 'Caption by Hyatt Namba Osaka', transport_mode: 'walking', coords: [34.6655, 135.5065] },
           { id: 105, time: '19:15', location: 'é“é¡¿å € (Dotonbori)', action: 'æ™šé¤/é€›è¡—', transport_detail: 'æ­¥è¡Œçº¦10åˆ†é’Ÿã€‚', 
             nav_query: 'Dotonbori Glico Sign', transport_mode: 'walking', coords: [34.6687, 135.5013], 
             foodOptions: [
                 {name:'è—å¯¿å¸ é“é¡¿å €åº—', desc:'ã€å¿…åƒã€‘æœ‰æ‰­è›‹ç©ï¼Œå­©å­æœ€çˆ±', query:'Kura Sushi Dotonbori', coords:[34.6680, 135.5010]},
                 {name:'åƒæˆ¿å¤§é˜ªçƒ§', desc:'å£æ„Ÿæ¾è½¯ï¼Œå­©å­æ¥å—åº¦é«˜', query:'Chibo Dotonbori', coords:[34.6685, 135.5032]}, 
                 {name:'ä¸€å…°æ‹‰é¢ æœ¬é¦†', desc:'ç‹¬ç«‹éš”é—´ï¼Œ9/12å²ä¼šè§‰å¾—æœ‰è¶£', query:'Ichiran Dotonbori Main Building', coords:[34.6698, 135.5025]}
             ],
             shopping: {name:'å”å‰è¯ƒå¾· (æ‘©å¤©è½®åº—)', desc:'äººå¤šï¼Œå»ºè®®é€Ÿæˆ˜é€Ÿå†³', query:'Don Quijote Dotonbori', coords:[34.6695, 135.5030]}
           }
       ],
       1: [
           { id: 201, time: '09:00', location: 'è¿‘é“æ—¥æœ¬æ¡¥ç«™', action: 'ç§»åŠ¨è‡³ç¥æˆ·', 
             transport_detail: 'æ­ä¹˜é˜ªç¥ç”µè½¦ "å¿«é€Ÿæ€¥è¡Œ" (Rapid Exp.) å¾€ç¥æˆ·ä¸‰å®«ã€‚', 
             nav_query: 'Kintetsu Nippombashi Station', transport_mode: 'transit', coords: [34.6672, 135.5065] },
           { id: 202, time: '11:30', location: 'ç¥æˆ·ä¸‰å®«', action: 'ç¥æˆ·ç‰›åˆé¤', 
             nav_query: 'Steakland Kobe-kan', transport_mode: 'walking', coords: [34.6930, 135.1915], 
             foodOptions: [
                 {name:'Steakland ç¥æˆ·é¦†', desc:'é“æ¿çƒ§è¡¨æ¼”ï¼Œå­©å­çœ‹å¾—å¼€å¿ƒ', query:'Steakland Kobe-kan', coords:[34.6929, 135.1917]},
                 {name:'Red Rock æœ¬åº—', desc:'æ»¡æ»¡çƒ¤ç‰›è‚‰ä¸¼ï¼Œè‚‰é£Ÿæ§é¦–é€‰', query:'Red Rock Sannomiya', coords:[34.6925, 135.1905]},
                 {name:'Moriya å‡›', desc:'è¾ƒé«˜çº§ï¼Œæœ‰å„¿ç«¥é¤å…·', query:'Moriya Lin', coords:[34.6928, 135.1910]}
             ] 
           },
           { id: 203, time: '14:00', location: 'ç¥æˆ· Mosaic å¹¿åœº', action: 'æ­ Uberå‰å¾€', recommend: true, 
             transport_detail: 'è¯·ç›´æ¥åœ¨ Uber è¾“å…¥ "Kobe Harborland umie Mosaic"ã€‚', 
             nav_query: 'Kobe Harborland umie Mosaic', transport_mode: 'driving', coords: [34.6795, 135.1843] },
           { id: 204, time: '14:30', location: 'Mosaic 3F æ‰­è›‹ç™¾è´§', action: 'å­©å­å¤©å ‚', isGame: true, 
             nav_query: 'Gashapon Department Store Mosaic', transport_mode: 'walking', coords: [34.6795, 135.1843], 
             shopping: {name:'æ‰­è›‹ç™¾è´§', desc:'å…³è¥¿æœ€å¤§çº§ï¼Œ2000å°æ‰­è›‹æ©Ÿ', query:'Gashapon Department Store Mosaic', coords:[34.6795, 135.1843]} },
           { id: 205, time: '17:30', location: 'ç¥æˆ·æ¸¯å¡”', action: 'å¤œæ™¯/æ•£æ­¥', 
             nav_query: 'Kobe Port Tower', transport_mode: 'walking', coords: [34.6815, 135.1765] },
           { id: 206, time: '19:00', location: 'æ—¥æœ¬æ¡¥ (å¤§é˜ª)', action: 'è¿”å›/æ™šé¤', 
             nav_query: 'Nippombashi Station', transport_mode: 'transit', coords: [34.6672, 135.5065],
             foodOptions: [
                 {name:'é¸Ÿè´µæ— éš¾æ³¢', desc:'å‡ä¸€ä»·ä¸²çƒ§ï¼Œå¯ç‚¹å¾ˆå¤šç§åˆ†é£Ÿ', query:'Torikizoku Namba', coords:[34.6675, 135.5055]},
                 {name:'å¤©æ”¿ä¹Œé¾™é¢', desc:'ä¾¿å®œå¿«é€Ÿï¼Œå­©å­ç´¯äº†åƒè¿™ä¸ª', query:'Tenmasa Udon Namba', coords:[34.6660, 135.5045]},
                 {name:'çƒ§è‚‰åŠ›ä¸¸', desc:'åƒåˆ°é¥±ï¼Œå¤§å­©å­æœ€çˆ±', query:'Yakiniku Rikimaru Namba', coords:[34.6650, 135.5030]}
             ]
           }
       ],
       2: [
           { id: 301, time: '09:30', location: 'é»‘é—¨å¸‚åœº', action: 'æ—©åˆé¤/åƒæ°´æœ', 
             nav_query: 'Kuromon Market', transport_mode: 'walking', coords: [34.6654, 135.5065] },
           { id: 302, time: '11:00', location: 'æ·€å±‹æ¡¥ç«™', action: 'ç§»åŠ¨è‡³äº¬éƒ½', recommend: true, 
             transport_detail: 'å»ºè®®å« Uber åˆ° "äº¬é˜ªæ·€å±‹æ¡¥ç«™" (Keihan Yodoyabashi)ï¼Œè¿™é‡Œæ˜¯äº¬é˜ªç”µè½¦èµ·ç‚¹ï¼Œå…¨å®¶æœ‰åº§ä½ã€‚', 
             nav_query: 'Yodoyabashi Station Keihan', transport_mode: 'driving', coords: [34.6930, 135.5015] },
           { id: 303, time: '12:30', location: 'Hyatt Place Kyoto', action: 'Check-in', isHotel: true, 
             transport_detail: 'ç¥å®«ä¸¸å¤ªç”ºç«™å‡ºæ¥ï¼Œç›´æ¥æ­ Uber å»é¥­åº—æœ€å¿«ã€‚', 
             nav_query: 'Hyatt Place Kyoto', transport_mode: 'driving', coords: [35.0163, 135.7592] },
           { id: 304, time: '13:30', location: 'é”¦å¸‚åœº', action: 'åˆé¤', 
             nav_query: 'Nishiki Market', transport_mode: 'driving', coords: [35.0050, 135.7630],
             foodOptions: [
                 {name:'åä»£çŒªæ’ ä¸‰æ¡æœ¬åº—', desc:'ã€é¦–é€‰ã€‘åº§ä½å®½æ•ï¼Œç™½é¥­é«˜ä¸½èœåƒåˆ°é¥±', query:'Katsukura Sanjo Main Store', coords:[35.0088, 135.7665]},
                 {name:'ä¸€é£å ‚ é”¦å°è·¯', desc:'è±šéª¨æ‹‰é¢ï¼Œä¸è¾£é€‚åˆå°å­©', query:'Ippudo Nishiki-Koji', coords:[35.0042, 135.7625]},
                 {name:'å¯Œå±±é»‘æ‹‰é¢', desc:'é‡å£å‘³é…±æ²¹ï¼Œå¯å°è¯•', query:'Menya Iroha Kyoto', coords:[35.0010, 135.7590]}
             ]
           },
           { id: 305, time: '15:30', location: 'Nintendo Kyoto', action: 'ä»»å¤©å ‚æ——èˆ°åº—', isGame: true, 
             nav_query: 'Nintendo Kyoto', transport_mode: 'walking', coords: [35.0038, 135.7695], 
             shopping: {name:'Nintendo Kyoto', desc:'é«˜å²›å±‹ T8 7Fï¼Œå»ºè®®å…ˆæ‹¿æ•´ç†åˆ¸', query:'Nintendo Kyoto', coords:[35.0038, 135.7695]} },
           { id: 306, time: '18:00', location: 'å››æ¡ä¹Œä¸¸', action: 'æ™šé¤', 
             nav_query: 'Shijo Station', transport_mode: 'walking', coords: [35.0035, 135.7595],
             foodOptions: [
                 {name:'CoCoå£¹ç•ªå±‹', desc:'æ—¥å¼å’–å“©ï¼Œå¯è°ƒè¾£åº¦/ä»½é‡', query:'CoCo Ichibanya Shijo Karasuma', coords:[35.0032, 135.7590]},
                 {name:'å¤§æˆ·å±‹ å››æ¡', desc:'å®šé£Ÿç±»ï¼Œæœ‰é±¼æœ‰è‚‰å¾ˆå¥åº·', query:'Ootoya Shijo Karasuma', coords:[35.0030, 135.7600]},
                 {name:'å¯¿å¸éƒ æ²³åŸç”º', desc:'å¦‚æœç¬¬ä¸€å¤©æ²¡åƒå¯¿å¸å¯æ¥è¿™', query:'Sushiro Kawaramachi', coords:[35.0040, 135.7690]}
             ]
           }
       ],
       3: [
           { id: 401, time: '08:30', location: 'ä¼è§ç¨»è·å¤§ç¤¾', action: 'åƒæœ¬é¸Ÿå±…', recommend: true, 
             transport_detail: 'è¯·ç›´æ¥ Uber è®¾å®šç›®çš„åœ°ï¼š"Fushimi Inari Taisha Parking Lot" (åœè½¦åœº)ï¼Œå°‘èµ°ä¸€æ®µä¸Šå¡ã€‚', 
             nav_query: 'Fushimi Inari Taisha Parking Lot', transport_mode: 'driving', coords: [34.9671, 135.7726] },
           { id: 402, time: '10:30', location: 'æ¸…æ°´å¯º', action: 'ç§»åŠ¨', transport: 'Uber', recommend: true, 
             transport_detail: 'Uber è®¾å®šç›®çš„åœ°ï¼š"Kiyomizu-michi Bus Stop" (æ¸…æ°´é“å…¬è½¦ç«™)ï¼Œä»è¿™è¾¹èµ°ä¸Šå»æ¯”è¾ƒé¡ºã€‚', 
             nav_query: 'Kiyomizu-michi Bus Stop', transport_mode: 'driving', coords: [34.9949, 135.7850] },
           { id: 403, time: '12:00', location: 'æ¸…æ°´é“', action: 'åˆé¤', 
             nav_query: 'Omen Kodaiji', transport_mode: 'walking', coords: [34.9960, 135.7830], 
             foodOptions: [
                 {name:'Omen ä¹Œé¾™é¢', desc:'ã€æ¨ã€‘ååº—ï¼Œä¹Œé¾™é¢å°å­©æ¥å—åº¦é«˜', query:'Omen Kodaiji', coords:[34.9990, 135.7800]},
                 {name:'å¥¥ä¸¹ æ¸…æ°´', desc:'æ±¤è±†è…ï¼Œç¯å¢ƒç¾ä½†å°å­©å¯èƒ½åƒä¸æƒ¯', query:'Okutan Kiyomizu', coords:[34.9965, 135.7835]},
                 {name:'å‰é‡å®¶', desc:'å¦‚æœå°å­©åµç€è¦åƒé¥­/ç‰›ä¸¼', query:'Yoshinoya Kiyomizu-dera', coords:[34.9960, 135.7830]}
             ] 
           },
           { id: 404, time: '14:30', location: 'ä¸‰å¹´å‚', action: 'å‰åœåŠ›/è§’è½ç”Ÿç‰©', isGame: true, 
             nav_query: 'Sannenzaka', transport_mode: 'walking', coords: [35.0035, 135.7780], 
             shopping: {name:'æ©¡å­å…±å’Œå›½', desc:'é¾™çŒ«å‘¨è¾¹', query:'Donguri Republic Ninen-zaka', coords:[34.9985, 135.7800]} },
           { id: 405, time: '18:00', location: 'æ²³åŸç”º', action: 'æ™šé¤/é€›è¡—', 
             nav_query: 'Gion Tanto', transport_mode: 'walking', coords: [35.0040, 135.7730],
             foodOptions: [
                 {name:'ç¥‡å›­ Tanto', desc:'é“æ¿çƒ§/å¤§é˜ªçƒ§ï¼Œåº§ä½ç¨æŒ¤ä½†å¥½åƒ', query:'Gion Tanto', coords:[35.0055, 135.7735]},
                 {name:'æ­¦è—å¯¿å¸', desc:'æ²³åŸç”ºäººæ°”å›è½¬å¯¿å¸', query:'Sushi no Musashi Sanjo', coords:[35.0090, 135.7695]},
                 {name:'æ˜Ÿä¹ƒå’–å•¡åº—', desc:'ä¹Ÿæœ‰ä¹‰å¤§åˆ©é¢/èˆ’èŠ™è•¾', query:'Hoshino Coffee Kawaramachi', coords:[35.0050, 135.7690]}
             ]
           },
           { id: 406, time: '20:00', location: 'Hyatt Place Kyoto', action: 'å›é¥­åº—', transport: 'Uber', 
             nav_query: 'Hyatt Place Kyoto', transport_mode: 'driving', coords: [35.0163, 135.7592] }
       ],
       4: [
           { id: 501, time: '08:05', location: 'äº¬éƒ½ç«™ å…«æ¡å£', action: 'å‰å¾€è½¦ç«™', recommend: true, 
             transport_detail: 'Uber è®¾å®šï¼š"Kyoto Station Hachijo Exit" (å…«æ¡å£)ã€‚', 
             nav_query: 'Kyoto Station Hachijo Exit', transport_mode: 'driving', coords: [34.9850, 135.7580] },
           { id: 502, time: '08:45', location: 'å…³ç©ºç‰¹æ€¥ Haruka', action: 'å‰å¾€æœºåœº', 
             transport_detail: 'ä»å…«æ¡å£è¿›ç«™ï¼Œæ‰¾ "30å·æœˆå°" (Platform 30)ã€‚', 
             nav_query: 'Kyoto Station Platform 30', transport_mode: 'transit', coords: [34.9850, 135.7580] },
           { id: 503, time: '10:05', location: 'å…³è¥¿æœºåœº T1', action: 'æœ€åé‡‡è´­/ç™»æœº', 
             nav_query: 'Pokemon Store Kansai Airport', transport_mode: 'walking', coords: [34.4357, 135.2443], 
             shopping: {name:'Pokemon Store', desc:'T1 2Fï¼Œæœ€åä¸€ç«™', query:'Pokemon Store Kansai Airport', coords:[34.4357, 135.2443]},
             foodOptions: [
                 {name:'ç¥åº§æ‹‰é¢ æœºåœºåº—', desc:'T1 3Fï¼Œå¤§é‡ç™½èœæ±¤å¤´å¾ˆç”œ', query:'Kamukura Kansai Airport', coords:[34.4350, 135.2440]},
                 {name:'Sukiya æœºåœºåº—', desc:'T1 2Fï¼Œå¿«é€Ÿè§£å†³', query:'Sukiya Kansai Airport', coords:[34.4355, 135.2445]},
                 {name:'551è“¬è±', desc:'T1 2F å¿…ä¹°çŒªè‚‰åŒ…(å¯å¤–å¸¦)', query:'551 Horai Kansai Airport', coords:[34.4360, 135.2450]}
             ]
           }
       ]
    };

    const app = createApp({
        data() {
            return {
                isAccessGranted: false,
                passcode: '',
                correctPasscode: 'alfredyiting', // å·²æ›´æ–°å¯†ç¢¼

                currentDay: 0,
                currentView: 'list',
                showModal: false,
                isEditing: false,
                showAllMap: true, 
                mapInstance: null,
                markerGroup: null,
                
                isLoading: false, 
                loadingText: 'è®€å–ä¸­...',
                progress: 0,

                touchStartX: 0, touchStartY: 0, touchEndX: 0, touchEndY: 0,
                
                days: [
                    { date: '12/05', weekday: 'é€±äº”', name: 'Day 1: å¤§é˜ª', locCoords: {lat: 34.6937, lon: 135.5023}, weather: { status: '...', icon: 'fas fa-spinner fa-spin', temp_high: '-', color: 'text-gray-400' } },
                    { date: '12/06', weekday: 'é€±å…­', name: 'Day 2: ç¥æˆ¶', locCoords: {lat: 34.6901, lon: 135.1955}, weather: { status: '...', icon: 'fas fa-spinner fa-spin', temp_high: '-', color: 'text-gray-400' } },
                    { date: '12/07', weekday: 'é€±æ—¥', name: 'Day 3: äº¬éƒ½', locCoords: {lat: 35.0116, lon: 135.7681}, weather: { status: '...', icon: 'fas fa-spinner fa-spin', temp_high: '-', color: 'text-gray-400' } },
                    { date: '12/08', weekday: 'é€±ä¸€', name: 'Day 4: äº¬éƒ½', locCoords: {lat: 35.0116, lon: 135.7681}, weather: { status: '...', icon: 'fas fa-spinner fa-spin', temp_high: '-', color: 'text-gray-400' } },
                    { date: '12/09', weekday: 'é€±äºŒ', name: 'Day 5: è¿”ç¨‹', locCoords: {lat: 34.4320, lon: 135.2304}, weather: { status: '...', icon: 'fas fa-spinner fa-spin', temp_high: '-', color: 'text-gray-400' } }
                ],
                activities: {},
                form: { id: null, time: '', location: '', action: '', transport_detail: '', coords: [], images: [] }
            }
        },
        computed: {
            currentActivities() { return this.activities[this.currentDay] || []; },
            sortedActivities() { return [...this.currentActivities].sort((a, b) => a.time.localeCompare(b.time)); }
        },
        mounted() { 
            this.loadAndMergeData(); 
            this.fetchRealTimeWeather();
            
            if(localStorage.getItem('trip_unlocked') === 'true') {
                this.isAccessGranted = true;
            }
        },
        methods: {
            // --- å¤©æ°£ API ---
            async fetchRealTimeWeather() {
                const year = new Date().getFullYear(); 
                this.days.forEach(async (day, index) => {
                    const [m, d] = day.date.split('/');
                    const apiDate = `${year}-${m}-${d}`;
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${day.locCoords.lat}&longitude=${day.locCoords.lon}&daily=weathercode,temperature_2m_max&timezone=Asia%2FTokyo&start_date=${apiDate}&end_date=${apiDate}`;

                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.daily && data.daily.weathercode) {
                            const code = data.daily.weathercode[0];
                            const temp = Math.round(data.daily.temperature_2m_max[0]);
                            const wInfo = this.getWeatherFromCode(code);
                            this.days[index].weather = { status: wInfo.status, icon: wInfo.icon, color: wInfo.color, temp_high: temp };
                        }
                    } catch (err) {
                        console.error("å¤©æ°£è®€å–å¤±æ•—", err);
                    }
                });
            },
            getWeatherFromCode(code) {
                if (code === 0) return { status: 'æ™´æœ—', icon: 'fas fa-sun', color: 'text-orange-500' };
                if ([1, 2, 3].includes(code)) return { status: 'å¤šé›²', icon: 'fas fa-cloud', color: 'text-gray-500' };
                if ([45, 48].includes(code)) return { status: 'èµ·éœ§', icon: 'fas fa-smog', color: 'text-slate-400' };
                if (code >= 51 && code <= 67) return { status: 'ä¸‹é›¨', icon: 'fas fa-umbrella', color: 'text-blue-500' };
                if (code >= 80) return { status: 'é™£é›¨', icon: 'fas fa-cloud-rain', color: 'text-blue-600' };
                return { status: 'é™°å¤©', icon: 'fas fa-cloud', color: 'text-gray-500' };
            },

            // --- è³‡æ–™è™•ç† ---
            loadAndMergeData() {
                this.isLoading = true;
                const tripRef = db.ref('trip_final_family_v1'); // æ›´æ”¹ key ä»¥å€éš”èˆŠè³‡æ–™
                tripRef.on('value', (snapshot) => {
                    const cloudData = snapshot.val();
                    if (cloudData) {
                        for(let i=0; i<this.days.length; i++) {
                            if(!cloudData[i]) cloudData[i] = [];
                            else {
                                cloudData[i].forEach(item => {
                                    if (!item.images) item.images = [];
                                });
                            }
                        }
                        this.activities = cloudData;
                    } else {
                        this.activities = JSON.parse(JSON.stringify(masterDataVFinal));
                        this.saveToStorage();
                    }
                    this.isLoading = false;
                });
            },
            
            saveToStorage() {
                db.ref('trip_final_family_v1').set(this.activities);
            },

            // --- åœ–ç‰‡ä¸Šå‚³ ---
            async uploadImages(event, item) {
                const files = event.target.files;
                if (!files.length) return;

                this.isLoading = true;
                this.loadingText = "ä¸Šå‚³ä¸­...";
                this.progress = 0;
                
                if (!item.images) item.images = [];
                let completed = 0;
                let hasError = false;

                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                        const fileName = `${Date.now()}_${i}_${safeName}`;
                        const filePath = `trip_photos_family/${fileName}`;
                        const storageRef = storage.ref().child(filePath);

                        try {
                            const snapshot = await storageRef.put(file);
                            const downloadURL = await snapshot.ref.getDownloadURL();
                            item.images.push({ url: downloadURL, storagePath: filePath });
                        } catch (error) {
                            console.error("ä¸Šå‚³å¤±æ•—", error);
                            alert(`ä¸Šå‚³å¤±æ•—: ${error.message}`);
                            hasError = true;
                        }
                        
                        completed++;
                        this.progress = Math.round((completed / files.length) * 100);
                    }
                } catch (err) {
                     alert("éŒ¯èª¤: " + err.message);
                } finally {
                    if (!hasError) this.saveToStorage();
                    this.isLoading = false;
                    event.target.value = ''; 
                }
            },

            deleteSingleImage(item, index) {
                if (!confirm("åˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ")) return;
                const imgData = item.images[index];
                if (imgData.storagePath) {
                    storage.ref().child(imgData.storagePath).delete().catch(err => console.log("é›²ç«¯æª”æ¡ˆå·²ä¸å­˜åœ¨"));
                }
                item.images.splice(index, 1);
                this.saveToStorage();
            },
            
            viewImage(url) { window.open(url, '_blank'); },

            // --- å…¶ä»–åŠŸèƒ½ ---
            checkPasscode() {
                if (this.passcode === this.correctPasscode) {
                    this.isAccessGranted = true;
                    localStorage.setItem('trip_unlocked', 'true');
                } else {
                    alert('å¯†ç¢¼éŒ¯èª¤ï¼');
                    this.passcode = '';
                }
            },
            getMainName(str) { return str ? str.split('(')[0] : ''; },
            getSubName(str) { 
                if(!str) return '';
                const match = str.match(/\(([^)]+)\)/);
                return match ? match[1] : '';
            },
            getIconColor(item) {
                if (item.isHotel) return 'bg-purple-500';
                if (item.isGame) return 'bg-red-500 ring-2 ring-red-200';
                return 'bg-blue-500';
            },
            generateGoogleLink(query, fallbackName, mode) {
                let q = query || fallbackName;
                if (!q) return '#';
                const encodedQ = encodeURIComponent(q);
                if (mode === 'walking') return `https://www.google.com/maps/search/?api=1&query=${encodedQ}`;
                return `https://www.google.com/maps/dir/?api=1&destination=${encodedQ}&travelmode=${mode || 'transit'}`;
            },
            changeDay(index) {
                this.currentDay = index; this.currentView = 'list'; this.showAllMap = false;
                const container = document.querySelector('.scroll-container');
                if(container) container.scrollTop = 0;
                if (this.mapInstance) this.$nextTick(() => { this.updateMapMarkers(); });
            },
            
            // --- åœ°åœ–èˆ‡å…¶ä»– ---
            switchMap() {
                this.currentView = 'map'; this.showAllMap = true;
                this.$nextTick(() => { if (!this.mapInstance) this.initMap(); else { this.mapInstance.invalidateSize(); this.updateMapMarkers(); } });
            },
            toggleMapMode() { this.showAllMap = !this.showAllMap; this.updateMapMarkers(); },
            initMap() {
                this.mapInstance = L.map('map');
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(this.mapInstance);
                this.markerGroup = L.layerGroup().addTo(this.mapInstance);
                this.updateMapMarkers();
            },
            updateMapMarkers() {
                if (!this.mapInstance || !this.markerGroup) return;
                this.markerGroup.clearLayers();
                let actsToShow = [];
                const bounds = [];
                
                const getItems = (d) => {
                    const list = this.activities[d] || [];
                    const markers = [];
                    list.forEach(item => {
                        if (item.coords) markers.push({...item, type: 'main'});
                        if (item.foodOptions) {
                            item.foodOptions.forEach(food => {
                                markers.push({
                                    coords: food.coords,
                                    location: food.name,
                                    action: 'æ¨è–¦é¤å»³',
                                    type: 'food'
                                });
                            });
                        }
                    });
                    return markers;
                };
                
                if (this.showAllMap) Object.keys(this.activities).forEach(k => actsToShow = actsToShow.concat(getItems(k)));
                else actsToShow = getItems(this.currentDay);

                actsToShow.forEach(item => {
                    let color = item.type === 'food' ? '#f97316' : (item.isHotel ? '#8b5cf6' : '#3b82f6');
                    let radius = item.type === 'food' ? 6 : 8;
                    
                    L.circleMarker(item.coords, { color: color, fillColor: color, fillOpacity: 0.8, radius: radius }).addTo(this.markerGroup)
                     .bindPopup(`<b>${this.getMainName(item.location)}</b><br><span style="font-size:11px">${item.action}</span>`);
                    bounds.push(item.coords);
                });
                if (bounds.length > 0) this.mapInstance.fitBounds(bounds, { padding: [50, 50] });
            },
            
            // --- ç·¨è¼¯ ---
            openModal(item = null) {
                this.isEditing = !!item;
                this.form = item ? JSON.parse(JSON.stringify(item)) : { id: Date.now(), time: '09:00', location: '', action: '', transport_detail: '', coords: [], images: [] };
                this.showModal = true;
            },
            saveActivity() {
                if (!this.form.location) return alert('è«‹è¼¸å…¥åœ°é»');
                if (!this.activities[this.currentDay]) this.activities[this.currentDay] = [];
                if (this.isEditing) {
                    const idx = this.activities[this.currentDay].findIndex(x => x.id === this.form.id);
                    if (idx !== -1) {
                         if(!this.form.images) this.form.images = [];
                         if(this.activities[this.currentDay][idx].foodOptions) {
                            this.form.foodOptions = this.activities[this.currentDay][idx].foodOptions;
                         }
                         this.activities[this.currentDay][idx] = this.form;
                    }
                } else {
                    this.activities[this.currentDay].push(this.form);
                }
                this.saveToStorage();
                this.showModal = false;
            },
            deleteActivity() {
                if(confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
                    this.activities[this.currentDay] = this.activities[this.currentDay].filter(x => x.id !== this.form.id);
                    this.saveToStorage();
                    this.showModal = false;
                }
            },
            resetData() {
                if(confirm('è­¦å‘Šï¼šç¢ºå®šé‡ç½®è¡Œç¨‹ï¼Ÿ(ä¸æœƒåˆªé™¤é›²ç«¯ç…§ç‰‡)')) {
                    this.activities = JSON.parse(JSON.stringify(masterDataVFinal));
                    this.saveToStorage();
                    this.currentDay = 0;
                }
            },
            async downloadMemories() {
                alert("åŠŸèƒ½æº–å‚™ä¸­ï¼šæ‰“åŒ…å›æ†¶");
            },
            handleTouchStart(e) { if(this.currentView !== 'list') return; this.touchStartX = e.changedTouches[0].screenX; this.touchStartY = e.changedTouches[0].screenY; },
            handleTouchEnd(e) { if(this.currentView !== 'list') return; this.touchEndX = e.changedTouches[0].screenX; this.touchEndY = e.changedTouches[0].screenY; 
                const diffX = this.touchStartX - this.touchEndX;
                if (Math.abs(diffX) > 50) {
                    if (diffX > 0 && this.currentDay < this.days.length - 1) this.changeDay(this.currentDay + 1);
                    else if (diffX < 0 && this.currentDay > 0) this.changeDay(this.currentDay - 1);
                }
            }
        }
    });
    app.mount('#app');
</script>
</body>
</html>
